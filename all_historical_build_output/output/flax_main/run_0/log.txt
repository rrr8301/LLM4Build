ERROR: Could not open requirements file: [Errno 2] No such file or directory: 'requirements.txt'
============================= test session starts ==============================
platform linux -- Python 3.10.12, pytest-8.4.1, pluggy-1.6.0
rootdir: /app
configfile: pyproject.toml
collected 2126 items / 31 errors

examples/gemma/helpers_test.py ...                                       [  0%]
examples/gemma/positional_embeddings_test.py ..                          [  0%]
examples/imagenet/models_test.py ...                                     [  0%]
examples/lm1b/temperature_sampler_test.py .                              [  0%]
tests/checkpoints_test.py ..........................                     [  1%]
tests/configurations_test.py .....                                       [  1%]
tests/core/core_frozen_dict_test.py ...................                  [  2%]
tests/core/core_lift_test.py .........                                   [  3%]
tests/core/core_meta_test.py ........                                    [  3%]
tests/core/core_scope_test.py ............F.........                     [  4%]
tests/core/design/core_attention_test.py .                               [  4%]
tests/core/design/core_auto_encoder_test.py ...                          [  4%]
tests/core/design/core_big_resnets_test.py .                             [  4%]
tests/core/design/core_custom_vjp_test.py .                              [  4%]
tests/core/design/core_dense_test.py ...                                 [  5%]
tests/core/design/core_flow_test.py .                                    [  5%]
tests/core/design/core_resnet_test.py .                                  [  5%]
tests/core/design/core_scan_test.py ..                                   [  5%]
tests/core/design/core_tied_autoencoder_test.py ..                       [  5%]
tests/core/design/core_vmap_test.py ..                                   [  5%]
tests/core/design/core_weight_std_test.py .                              [  5%]
tests/cursor_test.py ............                                        [  6%]
tests/early_stopping_test.py ...                                         [  6%]
tests/jax_utils_test.py ................................................ [  8%]
....................................................                     [ 10%]
tests/linen/initializers_test.py ....                                    [ 11%]
tests/linen/kw_only_dataclasses_test.py ....                             [ 11%]
tests/linen/linen_activation_test.py .                                   [ 11%]
tests/linen/linen_attention_test.py .......................              [ 12%]
tests/linen/linen_batch_apply_test.py .....                              [ 12%]
tests/linen/linen_combinators_test.py .......                            [ 12%]
tests/linen/linen_dtypes_test.py ...                                     [ 13%]
tests/linen/linen_linear_test.py ....................................... [ 14%]
........................................................................ [ 18%]
........................................................................ [ 21%]
........................................................................ [ 25%]
........................................................................ [ 28%]
........................................................................ [ 31%]
........................................................................ [ 35%]
........................................................................ [ 38%]
........................................................................ [ 42%]
.................................                                        [ 43%]
tests/linen/linen_meta_test.py ...                                       [ 43%]
tests/linen/linen_module_test.py ..............FF....................... [ 45%]
........................................................................ [ 48%]
...............................                                          [ 50%]
tests/linen/linen_recurrent_test.py .....................                [ 51%]
tests/linen/linen_test.py .............................................. [ 53%]
.....................................................                    [ 56%]
tests/linen/linen_transforms_test.py ................................... [ 57%]
.....................s................................                   [ 60%]
tests/linen/partitioning_test.py ..F.......................              [ 61%]
tests/linen/summary_test.py ................                             [ 62%]
tests/nnx/bridge/module_test.py .....F........                           [ 62%]
tests/nnx/bridge/wrappers_test.py ....F.....F.F.......FFF                [ 63%]
tests/nnx/containers_test.py ....                                        [ 64%]
tests/nnx/filters_test.py .                                              [ 64%]
tests/nnx/graph_utils_test.py .....FF.....F....F.F.FF..F.F.FFFFFFF.....F [ 66%]
.FFF.FF.....                                                             [ 66%]
tests/nnx/ids_test.py .                                                  [ 66%]
tests/nnx/integration_test.py F.......                                   [ 67%]
tests/nnx/metrics_test.py ........                                       [ 67%]
tests/nnx/mutable_array_test.py EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEFF         [ 69%]
tests/nnx/nn/attention_test.py ..F...................................... [ 70%]
.............................................................            [ 73%]
tests/nnx/nn/conv_test.py .............................................. [ 75%]
..........                                                               [ 76%]
tests/nnx/nn/embed_test.py ................                              [ 77%]
tests/nnx/nn/linear_test.py ............................................ [ 79%]
...............................                                          [ 80%]
tests/nnx/nn/lora_test.py ......                                         [ 80%]
tests/nnx/nn/normalization_test.py ..................................... [ 82%]
...........................                                              [ 84%]
tests/nnx/nn/recurrent_test.py ........F...........                      [ 84%]
tests/nnx/nn/stochastic_test.py FF.                                      [ 85%]
tests/nnx/optimizer_test.py FFFFFFFFFFFFFFFFFFFFFFF..FFFFFF              [ 86%]
tests/nnx/partitioning_test.py .........                                 [ 86%]
tests/nnx/rngs_test.py ..F..F...                                         [ 87%]
tests/nnx/spmd_test.py F.F.                                              [ 87%]
tests/nnx/state_test.py .....F..                                         [ 87%]
tests/nnx/summary_test.py .F                                             [ 88%]
tests/nnx/test_traversals.py ....                                        [ 88%]
tests/nnx/transforms_test.py ...FF......F...F.....FFF......FF........... [ 90%]
......F.F.F.........F...............FF.FF......FFFF.F...F..........F.    [ 93%]
tests/nnx/variable_test.py ..F....                                       [ 93%]
tests/pickle_test.py .                                                   [ 93%]
tests/serialization_test.py ............................................ [ 95%]
..............................................                           [ 98%]
tests/struct_test.py ............                                        [ 98%]
tests/traceback_util_test.py ....                                        [ 98%]
tests/traverse_util_test.py ........................                     [100%]

==================================== ERRORS ====================================
_________________ ERROR collecting docs/_ext/codediff_test.py __________________
ImportError while importing test module '/app/docs/_ext/codediff_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
docs/_ext/codediff_test.py:18: in <module>
    from codediff import CodeDiffParser
docs/_ext/codediff.py:30: in <module>
    import sphinx
E   ModuleNotFoundError: No module named 'sphinx'
_______________ ERROR collecting docs_nnx/_ext/codediff_test.py ________________
ImportError while importing test module '/app/docs_nnx/_ext/codediff_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
docs_nnx/_ext/codediff_test.py:18: in <module>
    from codediff import CodeDiffParser
docs_nnx/_ext/codediff.py:30: in <module>
    import sphinx
E   ModuleNotFoundError: No module named 'sphinx'
____________ ERROR collecting examples/gemma/input_pipeline_test.py ____________
ImportError while importing test module '/app/examples/gemma/input_pipeline_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
examples/gemma/input_pipeline_test.py:20: in <module>
    import tensorflow_datasets as tfds
E   ModuleNotFoundError: No module named 'tensorflow_datasets'
________________ ERROR collecting examples/gemma/layers_test.py ________________
ImportError while importing test module '/app/examples/gemma/layers_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
examples/gemma/layers_test.py:20: in <module>
    import layers
examples/gemma/layers.py:24: in <module>
    from jaxtyping import Array, ArrayLike  # pylint: disable=g-importing-member,g-multiple-import
E   ModuleNotFoundError: No module named 'jaxtyping'
_______________ ERROR collecting examples/gemma/modules_test.py ________________
ImportError while importing test module '/app/examples/gemma/modules_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
examples/gemma/modules_test.py:20: in <module>
    import modules
examples/gemma/modules.py:24: in <module>
    import layers
examples/gemma/layers.py:24: in <module>
    from jaxtyping import Array, ArrayLike  # pylint: disable=g-importing-member,g-multiple-import
E   ModuleNotFoundError: No module named 'jaxtyping'
_______________ ERROR collecting examples/gemma/sampler_test.py ________________
ImportError while importing test module '/app/examples/gemma/sampler_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
examples/gemma/sampler_test.py:21: in <module>
    import modules
examples/gemma/modules.py:24: in <module>
    import layers
examples/gemma/layers.py:24: in <module>
    from jaxtyping import Array, ArrayLike  # pylint: disable=g-importing-member,g-multiple-import
E   ModuleNotFoundError: No module named 'jaxtyping'
_____________ ERROR collecting examples/gemma/transformer_test.py ______________
ImportError while importing test module '/app/examples/gemma/transformer_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
examples/gemma/transformer_test.py:21: in <module>
    import modules
examples/gemma/modules.py:24: in <module>
    import layers
examples/gemma/layers.py:24: in <module>
    from jaxtyping import Array, ArrayLike  # pylint: disable=g-importing-member,g-multiple-import
E   ModuleNotFoundError: No module named 'jaxtyping'
_______________ ERROR collecting examples/imagenet/train_test.py _______________
ImportError while importing test module '/app/examples/imagenet/train_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
examples/imagenet/train_test.py:25: in <module>
    import tensorflow as tf
E   ModuleNotFoundError: No module named 'tensorflow'
____________ ERROR collecting examples/lm1b/input_pipeline_test.py _____________
ImportError while importing test module '/app/examples/lm1b/input_pipeline_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
examples/lm1b/input_pipeline_test.py:20: in <module>
    import tensorflow_datasets as tfds
E   ModuleNotFoundError: No module named 'tensorflow_datasets'
_________________ ERROR collecting examples/lm1b/train_test.py _________________
ImportError while importing test module '/app/examples/lm1b/train_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
examples/lm1b/train_test.py:21: in <module>
    import tensorflow as tf
E   ModuleNotFoundError: No module named 'tensorflow'
__________ ERROR collecting examples/lm1b_nnx/input_pipeline_test.py ___________
ImportError while importing test module '/app/examples/lm1b_nnx/input_pipeline_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
examples/lm1b_nnx/input_pipeline_test.py:20: in <module>
    import tensorflow_datasets as tfds
E   ModuleNotFoundError: No module named 'tensorflow_datasets'
______________ ERROR collecting examples/lm1b_nnx/models_test.py _______________
import file mismatch:
imported module 'models_test' has this __file__ attribute:
  /app/examples/imagenet/models_test.py
which is not the same as the test file we want to collect:
  /app/examples/lm1b_nnx/models_test.py
HINT: remove __pycache__ / .pyc files and/or use a unique basename for your test file modules
________ ERROR collecting examples/lm1b_nnx/temperature_sampler_test.py ________
import file mismatch:
imported module 'temperature_sampler_test' has this __file__ attribute:
  /app/examples/lm1b/temperature_sampler_test.py
which is not the same as the test file we want to collect:
  /app/examples/lm1b_nnx/temperature_sampler_test.py
HINT: remove __pycache__ / .pyc files and/or use a unique basename for your test file modules
_______________ ERROR collecting examples/lm1b_nnx/train_test.py _______________
ImportError while importing test module '/app/examples/lm1b_nnx/train_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
examples/lm1b_nnx/train_test.py:19: in <module>
    import tensorflow as tf
E   ModuleNotFoundError: No module named 'tensorflow'
________________ ERROR collecting examples/mnist/train_test.py _________________
ImportError while importing test module '/app/examples/mnist/train_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
examples/mnist/train_test.py:24: in <module>
    import tensorflow as tf
E   ModuleNotFoundError: No module named 'tensorflow'
___________ ERROR collecting examples/nlp_seq/input_pipeline_test.py ___________
ImportError while importing test module '/app/examples/nlp_seq/input_pipeline_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
examples/nlp_seq/input_pipeline_test.py:21: in <module>
    import tensorflow as tf
E   ModuleNotFoundError: No module named 'tensorflow'
________ ERROR collecting examples/ogbg_molpcba/input_pipeline_test.py _________
ImportError while importing test module '/app/examples/ogbg_molpcba/input_pipeline_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
examples/ogbg_molpcba/input_pipeline_test.py:19: in <module>
    import input_pipeline
examples/ogbg_molpcba/input_pipeline.py:20: in <module>
    import jraph
E   ModuleNotFoundError: No module named 'jraph'
____________ ERROR collecting examples/ogbg_molpcba/models_test.py _____________
import file mismatch:
imported module 'models_test' has this __file__ attribute:
  /app/examples/imagenet/models_test.py
which is not the same as the test file we want to collect:
  /app/examples/ogbg_molpcba/models_test.py
HINT: remove __pycache__ / .pyc files and/or use a unique basename for your test file modules
_____________ ERROR collecting examples/ogbg_molpcba/train_test.py _____________
ImportError while importing test module '/app/examples/ogbg_molpcba/train_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
examples/ogbg_molpcba/train_test.py:29: in <module>
    import jraph
E   ModuleNotFoundError: No module named 'jraph'
________________ ERROR collecting examples/ppo/ppo_lib_test.py _________________
ImportError while importing test module '/app/examples/ppo/ppo_lib_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
examples/ppo/ppo_lib_test.py:20: in <module>
    import ml_collections
E   ModuleNotFoundError: No module named 'ml_collections'
________________ ERROR collecting examples/ppo/test_episodes.py ________________
ImportError while importing test module '/app/examples/ppo/test_episodes.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
examples/ppo/test_episodes.py:24: in <module>
    import agent
examples/ppo/agent.py:27: in <module>
    import env_utils
examples/ppo/env_utils.py:19: in <module>
    import gymnasium as gym
E   ModuleNotFoundError: No module named 'gymnasium'
_______________ ERROR collecting examples/seq2seq/train_test.py ________________
ImportError while importing test module '/app/examples/seq2seq/train_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
examples/seq2seq/train_test.py:27: in <module>
    import train
examples/seq2seq/train.py:26: in <module>
    from clu import metric_writers
E   ModuleNotFoundError: No module named 'clu'
____________ ERROR collecting examples/sst2/input_pipeline_test.py _____________
ImportError while importing test module '/app/examples/sst2/input_pipeline_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
examples/sst2/input_pipeline_test.py:20: in <module>
    import tensorflow_datasets as tfds
E   ModuleNotFoundError: No module named 'tensorflow_datasets'
________________ ERROR collecting examples/sst2/models_test.py _________________
import file mismatch:
imported module 'models_test' has this __file__ attribute:
  /app/examples/imagenet/models_test.py
which is not the same as the test file we want to collect:
  /app/examples/sst2/models_test.py
HINT: remove __pycache__ / .pyc files and/or use a unique basename for your test file modules
_________________ ERROR collecting examples/sst2/train_test.py _________________
ImportError while importing test module '/app/examples/sst2/train_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
examples/sst2/train_test.py:22: in <module>
    from configs import default as default_config
examples/sst2/configs/default.py:17: in <module>
    import ml_collections
E   ModuleNotFoundError: No module named 'ml_collections'
_____________ ERROR collecting examples/wmt/input_pipeline_test.py _____________
ImportError while importing test module '/app/examples/wmt/input_pipeline_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
examples/wmt/input_pipeline_test.py:20: in <module>
    import tensorflow_datasets as tfds
E   ModuleNotFoundError: No module named 'tensorflow_datasets'
_________________ ERROR collecting examples/wmt/train_test.py __________________
ImportError while importing test module '/app/examples/wmt/train_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
examples/wmt/train_test.py:21: in <module>
    import tensorflow as tf
E   ModuleNotFoundError: No module named 'tensorflow'
______________________ ERROR collecting tests/io_test.py _______________________
ImportError while importing test module '/app/tests/io_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
tests/io_test.py:21: in <module>
    import tensorflow as tf
E   ModuleNotFoundError: No module named 'tensorflow'
__________________ ERROR collecting tests/nnx/helpers_test.py __________________
tests/nnx/helpers_test.py:29: in <module>
    class Dict(nnx.Module):
tests/nnx/helpers_test.py:30: in Dict
    items: nnx.Data[dict]
E   AttributeError: module 'flax.nnx' has no attribute 'Data'
__________________ ERROR collecting tests/nnx/module_test.py ___________________
ImportError while importing test module '/app/tests/nnx/module_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
tests/nnx/module_test.py:23: in <module>
    import cloudpickle
E   ModuleNotFoundError: No module named 'cloudpickle'
__________________ ERROR collecting tests/tensorboard_test.py __________________
ImportError while importing test module '/app/tests/tensorboard_test.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
tests/tensorboard_test.py:21: in <module>
    import tensorflow as tf
E   ModuleNotFoundError: No module named 'tensorflow'
________________ ERROR at setup of TestObject.test_data_example ________________

cls = <class 'nnx.mutable_array_test.TestObject'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:28: AttributeError
___________________ ERROR at setup of TestObject.test_pytree ___________________

cls = <class 'nnx.mutable_array_test.TestObject'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:28: AttributeError
____________ ERROR at setup of TestObject.test_pytree_data_instance ____________

cls = <class 'nnx.mutable_array_test.TestObject'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:28: AttributeError
____________ ERROR at setup of TestObject.test_pytree_data_typehint ____________

cls = <class 'nnx.mutable_array_test.TestObject'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:28: AttributeError
______________ ERROR at setup of TestObject.test_pytree_dataclass ______________

cls = <class 'nnx.mutable_array_test.TestObject'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:28: AttributeError
_____________ ERROR at setup of TestObject.test_register_data_type _____________

cls = <class 'nnx.mutable_array_test.TestObject'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:28: AttributeError
_______ ERROR at setup of TestMutableArrayGraph.test_freeze_and_mutable ________

cls = <class 'nnx.mutable_array_test.TestMutableArrayGraph'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:130: AttributeError
_ ERROR at setup of TestMutableArrayGraph.test_freeze_and_mutable_with_filter __

cls = <class 'nnx.mutable_array_test.TestMutableArrayGraph'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:130: AttributeError
_____ ERROR at setup of TestMutableArrayGraph.test_freeze_duplicate_error ______

cls = <class 'nnx.mutable_array_test.TestMutableArrayGraph'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:130: AttributeError
_______ ERROR at setup of TestMutableArrayGraph.test_mutable_array_split _______

cls = <class 'nnx.mutable_array_test.TestMutableArrayGraph'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:130: AttributeError
___ ERROR at setup of TestMutableArrayGraph.test_mutable_array_split_freeze ____

cls = <class 'nnx.mutable_array_test.TestMutableArrayGraph'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:130: AttributeError
_ ERROR at setup of TestMutableArrayGraph.test_mutable_array_split_merge_in_variable _

cls = <class 'nnx.mutable_array_test.TestMutableArrayGraph'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:130: AttributeError
_ ERROR at setup of TestMutableArrayGraph.test_mutable_array_split_merge_in_variable_shared_array _

cls = <class 'nnx.mutable_array_test.TestMutableArrayGraph'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:130: AttributeError
_________ ERROR at setup of TestMutableArrayGraph.test_mutable_example _________

cls = <class 'nnx.mutable_array_test.TestMutableArrayGraph'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:130: AttributeError
_______ ERROR at setup of TestMutableArrayGraph.test_split_mutable_array _______

cls = <class 'nnx.mutable_array_test.TestMutableArrayGraph'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:130: AttributeError
________ ERROR at setup of TestMutableArrayGraph.test_to_arrays_example ________

cls = <class 'nnx.mutable_array_test.TestMutableArrayGraph'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:130: AttributeError
_________ ERROR at setup of TestMutableArrayGraph.test_update_context __________

cls = <class 'nnx.mutable_array_test.TestMutableArrayGraph'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:130: AttributeError
_____ ERROR at setup of TestMutableArrayGraph.test_update_context_flatten ______

cls = <class 'nnx.mutable_array_test.TestMutableArrayGraph'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:130: AttributeError
_____ ERROR at setup of TestMutableArrayGraph.test_update_context_to_tree1 _____

cls = <class 'nnx.mutable_array_test.TestMutableArrayGraph'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:130: AttributeError
_____ ERROR at setup of TestMutableArrayGraph.test_update_context_to_tree2 _____

cls = <class 'nnx.mutable_array_test.TestMutableArrayGraph'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:130: AttributeError
_ ERROR at setup of TestMutableArrayGraph.test_update_context_to_tree_trivial_prefix _

cls = <class 'nnx.mutable_array_test.TestMutableArrayGraph'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:130: AttributeError
_______ ERROR at setup of TestMutableArrayNNXTransforms.test_jit_mutable _______

cls = <class 'nnx.mutable_array_test.TestMutableArrayNNXTransforms'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:482: AttributeError
_______ ERROR at setup of TestMutableArrayNNXTransforms.test_simple_jit ________

cls = <class 'nnx.mutable_array_test.TestMutableArrayNNXTransforms'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:482: AttributeError
________________ ERROR at setup of TestMutableArray.test_object ________________

cls = <class 'nnx.mutable_array_test.TestMutableArray'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:527: AttributeError
_____________ ERROR at setup of TestMutableArray.test_object_state _____________

cls = <class 'nnx.mutable_array_test.TestMutableArray'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:527: AttributeError
______________ ERROR at setup of TestMutableArray.test_rngs_call _______________

cls = <class 'nnx.mutable_array_test.TestMutableArray'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:527: AttributeError
_____________ ERROR at setup of TestMutableArray.test_rngs_create ______________

cls = <class 'nnx.mutable_array_test.TestMutableArray'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:527: AttributeError
________________ ERROR at setup of TestMutableArray.test_static ________________

cls = <class 'nnx.mutable_array_test.TestMutableArray'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:527: AttributeError
__________ ERROR at setup of TestMutableArray.test_variable_creation ___________

cls = <class 'nnx.mutable_array_test.TestMutableArray'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:527: AttributeError
__________ ERROR at setup of TestMutableArray.test_variable_metadata ___________

cls = <class 'nnx.mutable_array_test.TestMutableArray'>

    @classmethod
    def setUpClass(cls):
>     cls.using_refs = nnx.using_refs()
E     AttributeError: module 'flax.nnx' has no attribute 'using_refs'

tests/nnx/mutable_array_test.py:527: AttributeError
=================================== FAILURES ===================================
_____________________ ScopeTest.test_rng_check_w_lazy_rng ______________________

self = <core_scope_test.ScopeTest testMethod=test_rng_check_w_lazy_rng>

    def test_rng_check_w_lazy_rng(self):
      key = random.key(0)
>     self.assertTrue(scope._is_valid_rng(scope.LazyRng.create(key, 1)))
E     AssertionError: False is not true

tests/core/core_scope_test.py:202: AssertionError
______________________ ModuleTest.test_cloudpickle_class _______________________

self = <linen_module_test.ModuleTest testMethod=test_cloudpickle_class>

    def test_cloudpickle_class(self):
>     import cloudpickle
E     ModuleNotFoundError: No module named 'cloudpickle'

tests/linen/linen_module_test.py:2589: ModuleNotFoundError
______________________ ModuleTest.test_cloudpickle_module ______________________

self = <linen_module_test.ModuleTest testMethod=test_cloudpickle_module>

    def test_cloudpickle_module(self):
>     from cloudpickle import cloudpickle_fast
E     ModuleNotFoundError: No module named 'cloudpickle'

tests/linen/linen_module_test.py:2600: ModuleNotFoundError
__________________ PartitioningTest.test_logical_to_mesh_axes __________________

self = <partitioning_test.PartitioningTest testMethod=test_logical_to_mesh_axes>

    def test_logical_to_mesh_axes(self):
      axes_0 = ('foo', 'bar')
      # direct rule assignment
      self.assertEqual(
        partitioning.logical_to_mesh_axes(axes_0, rules=AXIS_RULES_1),
        ('data', 'model'),
      )

      # Repeated None and Unconstrained
      unconstrained = jax.sharding.PartitionSpec.UNCONSTRAINED
      axes_repeated = ('foo', unconstrained, unconstrained, None, None)
      self.assertEqual(
>         partitioning.logical_to_mesh_axes(axes_repeated, rules=AXIS_RULES_1),
          ('data', unconstrained, unconstrained, None, None),
      )

tests/linen/partitioning_test.py:64:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/linen/spmd.py:161: in logical_to_mesh_axes
    result = _logical_to_mesh_axes(array_dim_names, rules)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

array_dim_names = ('foo', UNCONSTRAINED, UNCONSTRAINED, None, None)
rules = (('foo', 'data'), ('bar', 'model'), ('baz', None))

    def _logical_to_mesh_axes(
        array_dim_names: Sequence[str | None] | None,
        rules: LogicalRules | None = None,
    ) -> list[_UnassignedAxis | None | str | tuple[str, ...]] | None:
      """Same as logical_to_mesh_axes, but doesn't fill in _unassigned_axis."""
      if array_dim_names is None:
        return None
      if rules is None:
        rules = get_logical_axis_rules()
      axis_name_counts = collections.Counter(array_dim_names)
      dups = tuple(
        k for k, v in axis_name_counts.items() if v > 1 and k is not None
      )
      if dups:
>       raise ValueError(
          f'Unsupported: Dimensions {dups} occur more than once in array names.'
        )
E       ValueError: Unsupported: Dimensions (UNCONSTRAINED,) occur more than once in array names.

/usr/local/lib/python3.10/dist-packages/flax/linen/spmd.py:100: ValueError
________________________ TestBridgeModule.test_metadata ________________________

self = <module_test.TestBridgeModule testMethod=test_metadata>

    def test_metadata(self):
      class Linear(bridge.Module):
        dout: int

        @bridge.compact
        def __call__(self, x):
          w = self.param(
            'w', bridge.with_partitioning(nnx.initializers.uniform(), ('in', 'out')),
            (x.shape[-1], self.dout)
          )
          b = self.param('b', nnx.initializers.zeros_init(), (self.dout,))
          return x @ w + b[None]

      foo = Linear(6)
      x = jnp.ones((4, 2))

      mesh = jax.make_mesh((2, 2), ('in', 'out'))
      with set_mesh(mesh):
        variables = foo.init(0, x)
        y: jax.Array = foo.apply(variables, x)

      params = variables['params']
      self.assertIsInstance(params['w'], nn.Partitioned)
      self.assertEqual(params['w'].value.shape, (2, 6))
>     self.assertEqual(params['w'].names, ('in', 'out'))
E     AttributeError: 'Partitioned' object has no attribute 'names'

tests/nnx/bridge/module_test.py:307: AttributeError
_________________ TestCompatibility.test_linen_to_nnx_metadata _________________

self = <wrappers_test.TestCompatibility testMethod=test_linen_to_nnx_metadata>

    def test_linen_to_nnx_metadata(self):
      linen_module = nn.Dense(
        features=64,
        kernel_init=nn.with_partitioning(nn.initializers.lecun_normal(),
                                         ('in', 'out')),
        bias_init=nn.with_logical_partitioning(nn.initializers.zeros_init(),
                                               ('out-alias',),
                                               rules=(('out-alias', 'out'),)),
        )
      x = jax.numpy.ones((1, 32))
      linen_vars = linen_module.init(jax.random.key(0), x)

      @nnx.jit
      def create_sharded_nnx_module(x):
        model = bridge.lazy_init(bridge.ToNNX(linen_module, rngs=nnx.Rngs(0)), x)
        state = nnx.state(model)
        sharded_state = jax.lax.with_sharding_constraint(state, nnx.get_partition_spec(state))
        nnx.update(model, sharded_state)
        return model
      with set_mesh(self.mesh):
        nnx_model = create_sharded_nnx_module(x)

      # nn.Partitioned metadata boxes translated into valid nnx.Variable boxes.
      self.assertIsInstance(linen_vars['params']['kernel'], nn.Partitioned)
      self.assertIsInstance(linen_vars['params']['bias'], nn.LogicallyPartitioned)
      self.assertIsInstance(nnx_model.kernel, nnx.Variable)
>     assert nnx_model.kernel.sharding_names == ('in', 'out')

tests/nnx/bridge/wrappers_test.py:182:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = Param( # 2,048 (8.2 KB)
  value=Array([[ 0.1902991 ,  0.27111685, -0.13641968, ...,  0.3014207 ,
          -0.31893888..., dtype=float32),
  mesh='None',
  sharding="('in', 'out')",
  linen_meta_type="<class 'flax.core.meta.Partitioned'>"
)
name = 'sharding_names'

    def __getattr__(self, name: str) -> tp.Any:
      if name in object.__getattribute__(self, '_var_metadata'):
        return self._var_metadata[name]
>     return getattr(self.raw_value, name)
E     AttributeError: 'jaxlib._jax.ArrayImpl' object has no attribute 'sharding_names'

/usr/local/lib/python3.10/dist-packages/flax/nnx/variablelib.py:187: AttributeError
_____________________ TestCompatibility.test_nnx_linen_nnx _____________________

self = <wrappers_test.TestCompatibility testMethod=test_nnx_linen_nnx>

    def test_nnx_linen_nnx(self):
      class NNXInner(nnx.Module):
        def __init__(self, din, dout, dropout_rate, rngs):
          self.w = nnx.Param(
            nnx.with_partitioning(nnx.initializers.lecun_normal(), sharding=('in', 'out')
                                  )(rngs.params(), (din, dout)))
          self.dropout = nnx.Dropout(rate=dropout_rate, rngs=rngs)
        def __call__(self, x):
          return self.dropout(x @ self.w.value)

      class LinenMiddle(nn.Module):
        dout: int
        dropout_rate: float
        @nn.compact
        def __call__(self, x):
          dot = bridge.to_linen(NNXInner, x.shape[-1], self.dout, self.dropout_rate, name='dot')
          logical_init = nn.with_logical_partitioning(
            nn.initializers.lecun_normal(), ('out-alias',), rules=(('out-alias', 'out'),))
          b = self.param('b', logical_init, (2, self.dout))
          return dot(x) + b

      class NNXOuter(nnx.Module):
        def __init__(self, dout: int, dropout_rate: float, *, rngs: nnx.Rngs):
          self.inner = bridge.ToNNX(LinenMiddle(dout, dropout_rate), rngs=rngs)
          self.rngs = rngs
        def __call__(self, x):
          return self.inner(x)

      x = jax.random.normal(jax.random.key(0), (2, 4))

      # Test the RNG
      with set_mesh(self.mesh):
        model = bridge.lazy_init(NNXOuter(dout=6, dropout_rate=0.5,
                                          rngs=nnx.Rngs(default=1, dropout=2)), x)
        nnx.reseed(model, dropout=2)
        y1, y2 = model(x), model(x)
        # The dropout key of lowest NNX level still changes over stateful calls
        assert not jnp.allclose(y1, y2)
        # Another reseed resets the RNG key back
        nnx.reseed(model, dropout=2)
        np.testing.assert_array_equal(y1, model(x))

      # Test the param value with disabled dropout
      with set_mesh(self.mesh):
        model = bridge.lazy_init(NNXOuter(dout=6, dropout_rate=0.,
                                          rngs=nnx.Rngs(default=1, dropout=2)), x)
        w, b = model.inner.dot['w'], model.inner.b
        np.testing.assert_allclose(model(x), x @ w + b)
      self.assertIsInstance(w, nnx.Param)
>     assert hasattr(w, 'sharding_names') and w.sharding_names == ('in', 'out')
E     assert (False)
E      +  where False = hasattr(Param( # 24 (96 B)\n  value=Array([[ 0.81883365, -1.0982083 ,  0.15520385,  0.46220285, -0.4449756 ,\n           0.13129...2105394,  0.29308668,  0.07858267,\n          -0.47290462]], dtype=float32),\n  sharding="('in', 'out')",\n  mesh='None'\n), 'sharding_names')

tests/nnx/bridge/wrappers_test.py:520: AssertionError
_________________ TestCompatibility.test_nnx_to_linen_metadata _________________

self = <wrappers_test.TestCompatibility testMethod=test_nnx_to_linen_metadata>

    def test_nnx_to_linen_metadata(self):
      model = bridge.to_linen(
        nnx.Linear, 32, 64,
        kernel_init=nnx.with_partitioning(nnx.initializers.lecun_normal(), ('in', 'out')))
      x = jax.numpy.ones((1, 32))
      with set_mesh(self.mesh):
        y, variables = model.init_with_output(jax.random.key(0), x)
        pspec_tree = nn.get_partition_spec(variables)
      assert y.shape == (1, 64)
      self.assertIsInstance(variables['params']['kernel'], nnx.bridge.NNXMeta)
>     assert variables['params']['kernel'].metadata['sharding_names'] == ('in', 'out')
E     KeyError: 'sharding_names'

tests/nnx/bridge/wrappers_test.py:411: KeyError
_________________ TestCompatibility.test_to_linen_abtract_init _________________

self = <wrappers_test.TestCompatibility testMethod=test_to_linen_abtract_init>

    def test_to_linen_abtract_init(self):
      test = self
      class Foo(nnx.Module):
        def __init__(self, *, rngs: nnx.Rngs):
          self.a = jnp.array(0.)

        def __call__(self):
          return self.a

      model = bridge.ToLinen(Foo)
      y = model.apply({})
      self.assertIsInstance(y, jax.ShapeDtypeStruct)

>     model = bridge.ToLinen(Foo, abstract_init=False)

tests/nnx/bridge/wrappers_test.py:541:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = ToLinen(
    # attributes
    nnx_class = None
    args = None
    kwargs = None
    skip_rng = None
    metadata_fn = None
)
args = (<class 'wrappers_test.TestCompatibility.test_to_linen_abtract_init.<locals>.Foo'>,)
kwargs = {'abstract_init': False}, num_args = 1

    @functools.wraps(dataclass_init)
    def init_wrapper(self, *args, **kwargs):
      num_args = len(args)
      if num_args > expected_num_args:
        # we add + 1 to each to account for `self`, matching python's
        # default error message
        raise TypeError(
          f'__init__() takes {expected_num_args + 1} positional '
          f'arguments but {num_args + 1} were given'
        )

>     dataclass_init(self, *args, **kwargs)
E     TypeError: ToLinen.__init__() got an unexpected keyword argument 'abstract_init'

/usr/local/lib/python3.10/dist-packages/flax/linen/kw_only_dataclasses.py:235: TypeError
_________________ TestCompatibility.test_to_linen_method_call __________________
jax.errors.SimplifiedTraceback: For simplicity, JAX has removed its internal frames from the traceback of the following exception. Set JAX_TRACEBACK_FILTERING=off to include these.

The above exception was the direct cause of the following exception:

self = <wrappers_test.TestCompatibility testMethod=test_to_linen_method_call>

    def test_to_linen_method_call(self):
      class Foo(nn.Module):
        def setup(self):
          self.embedding = nnx.bridge.to_linen(nnx.Embed, 2, 3)

        def __call__(self, x):
          return self.embedding(x)

        def attend(self, x):
          return self.embedding.attend(x)

      module = Foo()
      x = jnp.ones((1,), dtype=jnp.int32)
      z = jnp.ones((1, 3))
      y , params = module.init_with_output(jax.random.key(0), x)
      assert y.shape == (1, 3)
      assert params['params']['embedding']['embedding'].shape == (2, 3)
>     x_out = module.apply(params, z, method='attend')

tests/nnx/bridge/wrappers_test.py:344:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = Foo(
    # children
    embedding = ToLinen(
        # attributes
        nnx_class = Embed
        args = (2, 3)
        kwargs = FrozenDict({})
        skip_rng = False
        metadata_fn = to_linen_var
    )
)
x = Array([[1., 1., 1.]], dtype=float32)

    def attend(self, x):
>     return self.embedding.attend(x)
E     AttributeError: "ToLinen" object has no attribute "attend".

tests/nnx/bridge/wrappers_test.py:336: AttributeError
________________ TestCompatibility.test_to_linen_nnx_method_arg ________________
jax.errors.SimplifiedTraceback: For simplicity, JAX has removed its internal frames from the traceback of the following exception. Set JAX_TRACEBACK_FILTERING=off to include these.

The above exception was the direct cause of the following exception:

self = <wrappers_test.TestCompatibility testMethod=test_to_linen_nnx_method_arg>

    def test_to_linen_nnx_method_arg(self):
      module = nnx.bridge.to_linen(nnx.Embed, 2, 3)
      x = jnp.ones((1,), dtype=jnp.int32)
      z = jnp.ones((1, 3))
      y , params = module.init_with_output(jax.random.key(0), x)
      assert y.shape == (1, 3)
      assert params['params']['embedding'].shape == (2, 3)
>     x_out = module.apply(params, z, nnx_method='attend')

tests/nnx/bridge/wrappers_test.py:354:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = ToLinen(
    # attributes
    nnx_class = Embed
    args = (2, 3)
    kwargs = FrozenDict({})
    skip_rng = False
    metadata_fn = to_linen_var
)
args = (Array([[1., 1., 1.]], dtype=float32),)
kwargs = {'nnx_method': 'attend'}
module = Embed( # Param: 6 (24 B)
  dtype=dtype('float32'),
  embedding=Param( # 6 (24 B)
    value=Array(shape=(2, 3), dtype=d...,
  features=3,
  num_embeddings=2,
  param_dtype=float32,
  promote_dtype=<function promote_dtype at 0x7f5bbe391cf0>
)
maybe_unbox = <function ToLinen.__call__.<locals>.maybe_unbox at 0x7f565ad09a20>
states = [{'embedding': Array([[ 0.5909384 , -0.30460373,  0.14244974],
       [ 0.36590683,  0.09560514,  0.8897592 ]], dtype=float32)}]

    @linen.compact
    def __call__(self, *args, **kwargs):
      module_kwargs = dict(self.kwargs)
      maybe_add_default = not self.is_initializing()
      def _module_kwargs():
        if not self.skip_rng:
          module_kwargs['rngs'] = nnx.Rngs(
              **linen_rngs_dict(self, add_default=maybe_add_default)
          )
        return module_kwargs

      # init codepath
      if self.is_initializing():
        module = self.nnx_class(*self.args, **_module_kwargs())
        # TODO: add lazy_init here in case there's an `ToNNX` submodule under `module`.
        # update linen variables before call module to save initial state
        self._update_variables(module)
        out = module(*args, **kwargs)
        return out

      # create state
      def maybe_unbox(x):
        if isinstance(x, meta.AxisMetadata):
          return x.unbox()
        return x
      states = jtu.tree_map(
          maybe_unbox,
          list(self.variables.values()),
          is_leaf=lambda x: isinstance(x, meta.AxisMetadata),
      )
      if not states:
        states = ({},)

      # update module state
      module = nnx.eval_shape(
          lambda: self.nnx_class(*self.args, **_module_kwargs())
      )
      nnx.update(module, *states)
      nnx.reseed(
          module, **linen_rngs_dict(self, add_default=maybe_add_default)
      )  # reseed with keys from linen apply call.

>     out = module(*args, **kwargs)
E     TypeError: Embed.__call__() got an unexpected keyword argument 'nnx_method'

/usr/local/lib/python3.10/dist-packages/flax/nnx/bridge/wrappers.py:303: TypeError
_____________________ TestGraphUtils.test_data_after_init ______________________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_data_after_init>

    def test_data_after_init(self):
      test = self
      class Foo(nnx.Module):
        def __init__(self):
          self.ls = []
          self.ls.append(jnp.array(1))
          test.assertNotIn('ls', self._pytree__nodes)

>     m = Foo()

tests/nnx/graph_utils_test.py:1077:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:143: in __call__
    return _graph_node_meta_call(cls, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:152: in _graph_node_meta_call
    cls._object_meta_construct(node, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:146: in _object_meta_construct
    self.__init__(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = Foo(
  ls=[Array(1, dtype=int32, weak_type=True)]
)

    def __init__(self):
      self.ls = []
      self.ls.append(jnp.array(1))
>     test.assertNotIn('ls', self._pytree__nodes)
E     AttributeError: 'Foo' object has no attribute '_pytree__nodes'

tests/nnx/graph_utils_test.py:1075: AttributeError
_____________________ TestGraphUtils.test_find_duplicates ______________________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_find_duplicates>

    def test_find_duplicates(self):
      class SharedModules(nnx.Module):
        def __init__(self, rngs: nnx.Rngs):
          self.a = nnx.Linear(1, 1, rngs=rngs)
          self.b = nnx.Linear(1, 1, rngs=rngs)
          self.c = self.a  # shared Module

      model = SharedModules(nnx.Rngs(0))
>     duplicates = nnx.find_duplicates(model)
E     AttributeError: module 'flax.nnx' has no attribute 'find_duplicates'

tests/nnx/graph_utils_test.py:1129: AttributeError
_____________ TestGraphUtils.test_flatten_unflatten_unkown_leaves ______________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_flatten_unflatten_unkown_leaves>

    def test_flatten_unflatten_unkown_leaves(self):
      x = jnp.array(1.0)
>     graphdef, flat_state = nnx.graph.flatten(x)

tests/nnx/graph_utils_test.py:106:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

node = Array(1., dtype=float32, weak_type=True)

    def flatten(  # type: ignore[invalid-annotation]
      node: Node,
      /,
      *,
      with_paths: bool = True,
      return_variables: bool = False,
      ref_index: RefMap | None = None,
      ref_outer_index: RefMap | None = None,
    ) -> tuple[
      GraphDef[Node],
      FlatState[VariableState[tp.Any]] | FlatState[Variable[tp.Any]] | list[tp.Any],
    ]:
      """Flattens a graph node into a (graphdef, state) pair.

      Args:
        x: A graph node.
        ref_index: A mapping from nodes to indexes, defaults to None. If not provided, a new
          empty dictionary is created. This argument can be used to flatten a sequence of graph
          nodes that share references.
        with_paths: A boolean that indicates whether to return a FlatState object that includes
          the paths to VariableState objects, or just a list of the Variable's inner values.
      """
      if ref_index is None:
        ref_index = RefMap()

      leaves: list[LeafType] = []
      path: list[Key] | None = [] if with_paths else None
      paths: list[PathParts] | None = [] if with_paths else None
      nodes: list[NodeDefType[tp.Any]] = []
      attributes: list[tuple[Key, AttrType]] = []
      node_impl = get_node_impl(node)
      if node_impl is None and not (
        isinstance(node, Variable) or variablelib.is_mutable_array(node)
      ):
>       raise RuntimeError(f'Unsupported type: {type(node)}, this is a bug.')
E       RuntimeError: Unsupported type: <class 'jaxlib._jax.ArrayImpl'>, this is a bug.

/usr/local/lib/python3.10/dist-packages/flax/nnx/graph.py:680: RuntimeError
_________________ TestGraphUtils.test_object_state_propagation _________________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_object_state_propagation>

    def test_object_state_propagation(self):
      test = self

      class Foo(nnx.Module):
        def __call__(self):
          test.assertTrue(self._pytree__state.initializing)
          self = nnx.merge(*nnx.split(self))
          test.assertTrue(self._pytree__state.initializing)

      module = Foo()
>     nnx.bridge.lazy_init(module)

tests/nnx/graph_utils_test.py:554:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/bridge/wrappers.py:86: in lazy_init
    _ = fn(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = Foo()

    def __call__(self):
>     test.assertTrue(self._pytree__state.initializing)
E     AttributeError: 'Foo' object has no attribute '_pytree__state'

tests/nnx/graph_utils_test.py:549: AttributeError
_________________________ TestGraphUtils.test_pop_dict _________________________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_pop_dict>

    def test_pop_dict(self):
      node = {
        'a': {
          'b': jnp.array(1),
          'c': nnx.Param(2),
          'd': jnp.array(3.0),
        },
      }
      lt_2 = lambda _, x: x < 2
>     popped = nnx.pop(node, (nnx.Param, lt_2))

tests/nnx/graph_utils_test.py:1113:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/graph.py:2618: in pop
    _graph_pop(
/usr/local/lib/python3.10/dist-packages/flax/nnx/graph.py:1384: in _graph_pop
    _graph_pop(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

node = {'b': Array(1, dtype=int32, weak_type=True), 'c': Param(
  value=2
), 'd': Array(3., dtype=float32, weak_type=True)}
id_to_index = {140008821717952: 0, 140008822320832: 1}, path_parts = ('a',)
flat_states = ({},)
predicates = (Any(OfType(<class 'flax.nnx.variablelib.Param'>), <function TestGraphUtils.test_pop_dict.<locals>.<lambda> at 0x7f565ad08700>),)

    def _graph_pop(
      node: tp.Any,
      id_to_index: dict[int, Index],
      path_parts: PathParts,
      flat_states: tuple[dict[PathParts, LeafType], ...],
      predicates: tuple[filterlib.Predicate, ...],
    ) -> None:
      if not is_node(node):
        raise RuntimeError(f'Unsupported type: {type(node)}, this is a bug.')

      if id(node) in id_to_index:
        return

      id_to_index[id(node)] = len(id_to_index)
      node_impl = get_node_impl(node)
      if node_impl is None:
        raise TypeError(f'Unknown node type: {type(node)}')
      node_dict = node_impl.node_dict(node)

      for name, value in node_dict.items():
        if is_node(value):
          _graph_pop(
            node=value,
            id_to_index=id_to_index,
            path_parts=(*path_parts, name),
            flat_states=flat_states,
            predicates=predicates,
          )
          continue
        elif not is_node_leaf(value):
          continue
        elif id(value) in id_to_index:
          continue

        node_path = (*path_parts, name)
        node_impl = get_node_impl(node)
        if node_impl is None:
          raise TypeError(f'Unknown node type: {type(node)}')

        for state, predicate in zip(flat_states, predicates):
          if predicate(node_path, value):
            if isinstance(node_impl, PytreeNodeImpl):
>             raise ValueError(
                f'Cannot pop key {name!r} from node of type {type(node).__name__}'
              )
E             ValueError: Cannot pop key 'b' from node of type dict

/usr/local/lib/python3.10/dist-packages/flax/nnx/graph.py:1405: ValueError
_______________________ TestGraphUtils.test_pytree_node ________________________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_pytree_node>

    def test_pytree_node(self):
      @struct.dataclass
      class Tree:
        a: nnx.Param[int]
        b: str = struct.field(pytree_node=False)

      class Foo(nnx.Module):
        def __init__(self):
          self.tree = nnx.data(Tree(nnx.Param(1), 'a'))

>     m = Foo()

tests/nnx/graph_utils_test.py:358:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:143: in __call__
    return _graph_node_meta_call(cls, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:152: in _graph_node_meta_call
    cls._object_meta_construct(node, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:146: in _object_meta_construct
    self.__init__(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = Foo()

    def __init__(self):
>     self.tree = nnx.data(Tree(nnx.Param(1), 'a'))
E     AttributeError: module 'flax.nnx' has no attribute 'data'

tests/nnx/graph_utils_test.py:356: AttributeError
_________ TestGraphUtils.test_shared_state_variables_shared_with_graph _________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_shared_state_variables_shared_with_graph>

    def test_shared_state_variables_shared_with_graph(self):
      class Foo(nnx.Module):
        def __init__(self):
          p = nnx.Param(1)
          self.a = p
          self.b = p

      m = Foo()
      graphdef, state = nnx.split(m)

      assert isinstance(m.a, nnx.Param)
      assert isinstance(m.b, nnx.Param)
>     assert isinstance(state['a'], nnx.Param)
E     AssertionError: assert False
E      +  where False = isinstance(VariableState(\n  type=Param,\n  value=1\n), <class 'flax.nnx.variablelib.Param'>)
E      +    where <class 'flax.nnx.variablelib.Param'> = nnx.Param

tests/nnx/graph_utils_test.py:310: AssertionError
__________________ TestGraphUtils.test_split_filter_variable ___________________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_split_filter_variable>

    def test_split_filter_variable(self):
      v = nnx.Param(1)
      graphdef, batch_stats, params, rest = nnx.split(
        v, nnx.BatchStat, nnx.Param, ...
      )

      self.assertIsInstance(graphdef.nodes[0], nnx.graph.VariableDef)
>     self.assertIsInstance(params, nnx.Variable)
E     AssertionError: VariableState(
E       type=Param,
E       value=1
E     ) is not an instance of <class 'flax.nnx.variablelib.Variable'>

tests/nnx/graph_utils_test.py:926: AssertionError
_______________ TestGraphUtils.test_split_merge_context_example ________________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_split_merge_context_example>

    def test_split_merge_context_example(self):
>     m1 = Dict({})

tests/nnx/graph_utils_test.py:599:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:143: in __call__
    return _graph_node_meta_call(cls, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:152: in _graph_node_meta_call
    cls._object_meta_construct(node, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:146: in _object_meta_construct
    self.__init__(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = Dict(), args = ({},), kwargs = {}

    def __init__(self, *args, **kwargs):
>     self.items = nnx.data(dict(*args, **kwargs))
E     AttributeError: module 'flax.nnx' has no attribute 'data'

tests/nnx/graph_utils_test.py:40: AttributeError
________________ TestGraphUtils.test_split_merge_unkown_leaves _________________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_split_merge_unkown_leaves>

    def test_split_merge_unkown_leaves(self):
      x = jnp.array(1.0)
>     graphdef, state = nnx.graph.split(x)

tests/nnx/graph_utils_test.py:115:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/graph.py:2275: in split
    graphdef, flat_state = flatten(node)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

node = Array(1., dtype=float32, weak_type=True)

    def flatten(  # type: ignore[invalid-annotation]
      node: Node,
      /,
      *,
      with_paths: bool = True,
      return_variables: bool = False,
      ref_index: RefMap | None = None,
      ref_outer_index: RefMap | None = None,
    ) -> tuple[
      GraphDef[Node],
      FlatState[VariableState[tp.Any]] | FlatState[Variable[tp.Any]] | list[tp.Any],
    ]:
      """Flattens a graph node into a (graphdef, state) pair.

      Args:
        x: A graph node.
        ref_index: A mapping from nodes to indexes, defaults to None. If not provided, a new
          empty dictionary is created. This argument can be used to flatten a sequence of graph
          nodes that share references.
        with_paths: A boolean that indicates whether to return a FlatState object that includes
          the paths to VariableState objects, or just a list of the Variable's inner values.
      """
      if ref_index is None:
        ref_index = RefMap()

      leaves: list[LeafType] = []
      path: list[Key] | None = [] if with_paths else None
      paths: list[PathParts] | None = [] if with_paths else None
      nodes: list[NodeDefType[tp.Any]] = []
      attributes: list[tuple[Key, AttrType]] = []
      node_impl = get_node_impl(node)
      if node_impl is None and not (
        isinstance(node, Variable) or variablelib.is_mutable_array(node)
      ):
>       raise RuntimeError(f'Unsupported type: {type(node)}, this is a bug.')
E       RuntimeError: Unsupported type: <class 'jaxlib._jax.ArrayImpl'>, this is a bug.

/usr/local/lib/python3.10/dist-packages/flax/nnx/graph.py:680: RuntimeError
__________ TestGraphUtils.test_split_merge_unkown_leaves_with_filters __________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_split_merge_unkown_leaves_with_filters>

    def test_split_merge_unkown_leaves_with_filters(self):
      x = jnp.array(1.0)
>     graphdef, state, rest = nnx.graph.split(x, jax.Array, ...)

tests/nnx/graph_utils_test.py:124:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/graph.py:2275: in split
    graphdef, flat_state = flatten(node)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

node = Array(1., dtype=float32, weak_type=True)

    def flatten(  # type: ignore[invalid-annotation]
      node: Node,
      /,
      *,
      with_paths: bool = True,
      return_variables: bool = False,
      ref_index: RefMap | None = None,
      ref_outer_index: RefMap | None = None,
    ) -> tuple[
      GraphDef[Node],
      FlatState[VariableState[tp.Any]] | FlatState[Variable[tp.Any]] | list[tp.Any],
    ]:
      """Flattens a graph node into a (graphdef, state) pair.

      Args:
        x: A graph node.
        ref_index: A mapping from nodes to indexes, defaults to None. If not provided, a new
          empty dictionary is created. This argument can be used to flatten a sequence of graph
          nodes that share references.
        with_paths: A boolean that indicates whether to return a FlatState object that includes
          the paths to VariableState objects, or just a list of the Variable's inner values.
      """
      if ref_index is None:
        ref_index = RefMap()

      leaves: list[LeafType] = []
      path: list[Key] | None = [] if with_paths else None
      paths: list[PathParts] | None = [] if with_paths else None
      nodes: list[NodeDefType[tp.Any]] = []
      attributes: list[tuple[Key, AttrType]] = []
      node_impl = get_node_impl(node)
      if node_impl is None and not (
        isinstance(node, Variable) or variablelib.is_mutable_array(node)
      ):
>       raise RuntimeError(f'Unsupported type: {type(node)}, this is a bug.')
E       RuntimeError: Unsupported type: <class 'jaxlib._jax.ArrayImpl'>, this is a bug.

/usr/local/lib/python3.10/dist-packages/flax/nnx/graph.py:680: RuntimeError
________________ TestGraphUtils.test_split_merge_update_context ________________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_split_merge_update_context>

    def test_split_merge_update_context(self):
      class Foo(nnx.Module):
        def __init__(self):
          self.a = nnx.Param(1)
          self.b = nnx.data(2)

>     m = Foo()

tests/nnx/graph_utils_test.py:643:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:143: in __call__
    return _graph_node_meta_call(cls, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:152: in _graph_node_meta_call
    cls._object_meta_construct(node, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:146: in _object_meta_construct
    self.__init__(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = Foo(
  a=Param(
    value=1
  )
)

    def __init__(self):
      self.a = nnx.Param(1)
>     self.b = nnx.data(2)
E     AttributeError: module 'flax.nnx' has no attribute 'data'

tests/nnx/graph_utils_test.py:641: AttributeError
_______________ TestGraphUtils.test_split_update_filter_variable _______________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_split_update_filter_variable>

    def test_split_update_filter_variable(self):
      v = nnx.Param(1)
      graphdef, batch_stats, params, rest = nnx.split(
        v, nnx.BatchStat, nnx.Param, ...
      )

      self.assertIsInstance(graphdef.nodes[0], nnx.graph.VariableDef)
>     self.assertIsInstance(params, nnx.Variable)
E     AssertionError: VariableState(
E       type=Param,
E       value=1
E     ) is not an instance of <class 'flax.nnx.variablelib.Variable'>

tests/nnx/graph_utils_test.py:954: AssertionError
__________________ TestGraphUtils.test_split_update_variable ___________________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_split_update_variable>

    def test_split_update_variable(self):
      v = nnx.Param(1)
      graphdef, state = nnx.split(v)

      self.assertIsInstance(graphdef.nodes[0], nnx.graph.VariableDef)
>     self.assertIsInstance(state, nnx.Variable)
E     AssertionError: VariableState(
E       type=Param,
E       value=1
E     ) is not an instance of <class 'flax.nnx.variablelib.Variable'>

tests/nnx/graph_utils_test.py:940: AssertionError
______________________ TestGraphUtils.test_split_variable ______________________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_split_variable>

    def test_split_variable(self):
      v = nnx.Param(1)
      graphdef, state = nnx.split(v)

      self.assertIsInstance(graphdef.nodes[0], nnx.graph.VariableDef)
>     self.assertIsInstance(state, nnx.Variable)
E     AssertionError: VariableState(
E       type=Param,
E       value=1
E     ) is not an instance of <class 'flax.nnx.variablelib.Variable'>

tests/nnx/graph_utils_test.py:914: AssertionError
____________ TestGraphUtils.test_state_variables_shared_with_graph _____________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_state_variables_shared_with_graph>

    def test_state_variables_shared_with_graph(self):
      class Foo(nnx.Module):
        def __init__(self):
          self.a = nnx.Param(1)

      m = Foo()
      graphdef, state = nnx.split(m)

      assert isinstance(m.a, nnx.Param)
>     assert isinstance(state['a'], nnx.Param)
E     AssertionError: assert False
E      +  where False = isinstance(VariableState(\n  type=Param,\n  value=1\n), <class 'flax.nnx.variablelib.Param'>)
E      +    where <class 'flax.nnx.variablelib.Param'> = nnx.Param

tests/nnx/graph_utils_test.py:287: AssertionError
__________________ TestGraphUtils.test_to_tree_update_context __________________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_to_tree_update_context>

    def test_to_tree_update_context(self):
      class Foo(nnx.Module):
        def __init__(self):
          self.a = nnx.Param(1)
          self.b = nnx.data(2)

>     m = Foo()

tests/nnx/graph_utils_test.py:726:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:143: in __call__
    return _graph_node_meta_call(cls, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:152: in _graph_node_meta_call
    cls._object_meta_construct(node, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:146: in _object_meta_construct
    self.__init__(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = Foo(
  a=Param(
    value=1
  )
)

    def __init__(self):
      self.a = nnx.Param(1)
>     self.b = nnx.data(2)
E     AttributeError: module 'flax.nnx' has no attribute 'data'

tests/nnx/graph_utils_test.py:724: AttributeError
________________________ TestGraphUtils.test_unflatten _________________________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_unflatten>

    def test_unflatten(self):
>     a = Dict(a=1, b=nnx.Param(2))

tests/nnx/graph_utils_test.py:96:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:143: in __call__
    return _graph_node_meta_call(cls, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:152: in _graph_node_meta_call
    cls._object_meta_construct(node, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:146: in _object_meta_construct
    self.__init__(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = Dict(), args = (), kwargs = {'a': 1, 'b': Param(
  value=2
)}

    def __init__(self, *args, **kwargs):
>     self.items = nnx.data(dict(*args, **kwargs))
E     AttributeError: module 'flax.nnx' has no attribute 'data'

tests/nnx/graph_utils_test.py:40: AttributeError
_____________________ TestGraphUtils.test_unflatten_empty ______________________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_unflatten_empty>

    def test_unflatten_empty(self):
>     a = Dict({'a': 1, 'b': nnx.Param(2)})

tests/nnx/graph_utils_test.py:152:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:143: in __call__
    return _graph_node_meta_call(cls, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:152: in _graph_node_meta_call
    cls._object_meta_construct(node, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:146: in _object_meta_construct
    self.__init__(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = Dict(), args = ({'a': 1, 'b': Param(
  value=2
)},), kwargs = {}

    def __init__(self, *args, **kwargs):
>     self.items = nnx.data(dict(*args, **kwargs))
E     AttributeError: module 'flax.nnx' has no attribute 'data'

tests/nnx/graph_utils_test.py:40: AttributeError
___________________ TestGraphUtils.test_unflatten_pure_dict ____________________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_unflatten_pure_dict>

    def test_unflatten_pure_dict(self):
>     a = Dict(a=1, b=nnx.Param(2))

tests/nnx/graph_utils_test.py:132:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:143: in __call__
    return _graph_node_meta_call(cls, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:152: in _graph_node_meta_call
    cls._object_meta_construct(node, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:146: in _object_meta_construct
    self.__init__(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = Dict(), args = (), kwargs = {'a': 1, 'b': Param(
  value=2
)}

    def __init__(self, *args, **kwargs):
>     self.items = nnx.data(dict(*args, **kwargs))
E     AttributeError: module 'flax.nnx' has no attribute 'data'

tests/nnx/graph_utils_test.py:40: AttributeError
________________ TestGraphUtils.test_unflatten_return_variables ________________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_unflatten_return_variables>

    def test_unflatten_return_variables(self):
>     a = Dict({'a': 1, 'b': nnx.Param(2)})

tests/nnx/graph_utils_test.py:161:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:143: in __call__
    return _graph_node_meta_call(cls, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:152: in _graph_node_meta_call
    cls._object_meta_construct(node, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:146: in _object_meta_construct
    self.__init__(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = Dict(), args = ({'a': 1, 'b': Param(
  value=2
)},), kwargs = {}

    def __init__(self, *args, **kwargs):
>     self.items = nnx.data(dict(*args, **kwargs))
E     AttributeError: module 'flax.nnx' has no attribute 'data'

tests/nnx/graph_utils_test.py:40: AttributeError
_______________________ TestGraphUtils.test_update_dict ________________________

self = <nnx.graph_utils_test.TestGraphUtils testMethod=test_update_dict>

    def test_update_dict(self):
      node = {
        'a': {
          'b': 1,
          'c': nnx.Param(2),
          'd': 3,
        },
      }

      updates = {
        'a': {
          'b': 4,
          'c': 10,
        },
      }

>     nnx.update(node, updates)

tests/nnx/graph_utils_test.py:1098:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/graph.py:2413: in update
    _graph_update_dynamic(node, state)
/usr/local/lib/python3.10/dist-packages/flax/nnx/graph.py:1464: in _graph_update_dynamic
    _graph_update_dynamic(current_value, value)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

node = {'b': 1, 'c': Param(
  value=2
), 'd': 3}, state = {'b': 4, 'c': 10}

    def _graph_update_dynamic(node: tp.Any, state: tp.Mapping[KeyT, tp.Any]):
      def _update_variable(node: Variable, value):
        if isinstance(value, VariableState):
          # updated from VariableState
          node.update_from_state(value)
        else:
          # updated from raw value
          if isinstance(value, State) and not value:
            # NOTE: this is a special case when trying to update a Variable from state
            # created when flattening into a NodeRef, which creates an empty State. This
            # can happen when using standalone Variables with `grad`
            pass
          else:
            node.raw_value = value

      if isinstance(node, Variable):
        _update_variable(node, state)
        return

      if not is_node(node):
        raise RuntimeError(f'Unsupported type: {type(node)}')

      node_impl = get_node_impl(node)
      if node_impl is None:
        raise TypeError(f'Unknown node type: {type(node)}')
      node_dict = node_impl.node_dict(node)
      for key, value in state.items():
        # case 1: new state is being added
        if key not in node_dict:
          if isinstance(node_impl, PytreeNodeImpl):
            raise ValueError(
              f'Cannot set key {key!r} on immutable node of '
              f'type {type(node).__name__}'
            )
          if isinstance(value, Variable):
            value = value.copy()
          node_impl.set_key(node, key, value)
          continue

        current_value = node_dict[key]

        # case 2: subgraph is being updated
        if is_node(current_value):
          if is_node_leaf(value):
            raise ValueError(f'Expected a subgraph for {key!r}, but got: {value!r}')
          _graph_update_dynamic(current_value, value)
        else:
          if isinstance(current_value, jax.Array | np.ndarray):
            if isinstance(node_impl, PytreeNodeImpl):
              raise ValueError(
                f'Cannot set key {key!r} on immutable node of '
                f'type {type(node).__name__}'
              )
            node_impl.set_key(node, key, value)
            continue
          elif not isinstance(current_value, Variable):
            # case 3: state leaf is being updated
>           raise ValueError(
              f'Trying to update a non-Variable attribute {key!r} with a Variable: '
              f'{value!r}'
            )
E           ValueError: Trying to update a non-Variable attribute 'b' with a Variable: 4

/usr/local/lib/python3.10/dist-packages/flax/nnx/graph.py:1476: ValueError
_________________ TestIntegration.test_example_mutable_arrays __________________

self = <nnx.integration_test.TestIntegration testMethod=test_example_mutable_arrays>

    def test_example_mutable_arrays(self):
      class Model(nnx.Module):
        def __init__(self, din, dmid, dout, rngs: nnx.Rngs):
          self.linear = nnx.Linear(din, dmid, rngs=rngs)
          self.bn = nnx.BatchNorm(dmid, rngs=rngs)
          self.dropout = nnx.Dropout(0.2, rngs=rngs)
          self.linear_out = nnx.Linear(dmid, dout, rngs=rngs)

        def __call__(self, x):
          x = nnx.relu(self.dropout(self.bn(self.linear(x))))
          return self.linear_out(x)

>     with nnx.use_refs(True):
E     AttributeError: module 'flax.nnx' has no attribute 'use_refs'

tests/nnx/integration_test.py:315: AttributeError
______________________ TestOptimizer.test_optimize_arrays ______________________

self = <nnx.mutable_array_test.TestOptimizer testMethod=test_optimize_arrays>

    def test_optimize_arrays(self):
      class Model(nnx.Module):
        def __init__(self, rngs):
          self.w = jax.random.uniform(rngs(), (2, 4))
          self.count = jnp.array(0)

        def __call__(self, x):
          self.count += 1
          return x @ self.w

      x = jax.random.normal(jax.random.key(0), (5, 2))
      y = jnp.ones((5, 4))

>     with nnx.use_refs(False):
E     AttributeError: module 'flax.nnx' has no attribute 'use_refs'

tests/nnx/mutable_array_test.py:689: AttributeError
__________________ TestOptimizer.test_optimize_mutable_arrays __________________

self = <nnx.mutable_array_test.TestOptimizer testMethod=test_optimize_mutable_arrays>

    def test_optimize_mutable_arrays(self):
      class Model(nnx.Module):
        def __init__(self, rngs):
          self.w = nnx.array_ref(jax.random.uniform(rngs(), (2, 4)))
          self.count = nnx.array_ref(jnp.array(0))

        def __call__(self, x):
          self.count[...] += 1
          return x @ self.w

      x = jax.random.normal(jax.random.key(0), (5, 2))
      y = jnp.ones((5, 4))

>     with nnx.use_refs(True):
E     AttributeError: module 'flax.nnx' has no attribute 'use_refs'

tests/nnx/mutable_array_test.py:729: AttributeError
____________________ TestMultiHeadAttention.test_keep_rngs0 ____________________

self = <attention_test.TestMultiHeadAttention testMethod=test_keep_rngs0>
keep_rngs = True

    @parameterized.product(keep_rngs=[True, False])
    def test_keep_rngs(self, keep_rngs):
      rngs = nnx.Rngs(42)
      module = nnx.MultiHeadAttention(
        in_features=4,
        num_heads=2,
        qkv_features=4,
        decode=True,
        rngs=rngs,
        dropout_rate=0.5,
        keep_rngs=keep_rngs
      )
      if keep_rngs:
        assert module.rngs is not None
      else:
        assert module.rngs is None
      if keep_rngs:
        _, _, nondiff = nnx.split(module, nnx.Param, ...)
>       assert isinstance(nondiff['rngs']['count'], nnx.RngCount)

tests/nnx/nn/attention_test.py:124:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = State({
  'default': {
    'count': VariableState( # 1 (4 B)
      type=RngCount,
      value=Array(8, dtype=uint32),
...B)
      type=RngKey,
      value=Array((), dtype=key<fry>) overlaying:
      [ 0 42],
      tag='default'
    )
  }
})
key = 'count'

    def __getitem__(self, key: K) -> State | V:  # type: ignore
>     value = self._mapping[key]
E     KeyError: 'count'

/usr/local/lib/python3.10/dist-packages/flax/nnx/statelib.py:260: KeyError
________________________ TestRNN.test_recurrent_dropout ________________________

self = <recurrent_test.TestRNN testMethod=test_recurrent_dropout>

    def test_recurrent_dropout(self):
      class LSTMWithRecurrentDropout(nnx.OptimizedLSTMCell):
        def __init__(
          self,
          *,
          rngs: nnx.Rngs,
          in_features: int,
          hidden_features: int,
          dropout_rate: float,
          **kwargs,
        ):
          super().__init__(
            in_features=in_features,
            hidden_features=hidden_features,
            rngs=rngs,
            keep_rngs=True,
            **kwargs,
          )
          self.recurrent_dropout = nnx.Dropout(
            rate=dropout_rate, rng_collection='recurrent_dropout', rngs=rngs
          )

        def __call__(self, carry, x):
          h, c = carry
          new_h, new_c = super().__call__((h, c), x)
          new_h = jax.tree.map(self.recurrent_dropout, new_h)
          return new_h, new_c

      class RNNWithRecurrentDropout(nnx.Module):
        def __init__(
          self,
          *,
          rngs: nnx.Rngs,
          in_features: int,
          hidden_features: int = 32,
          dropout_rate: float = 0.5,
          recurrent_dropout_rate: float = 0.25,
        ):
          cell = LSTMWithRecurrentDropout(
            in_features=in_features,
            hidden_features=hidden_features,
            rngs=rngs,
            dropout_rate=recurrent_dropout_rate,
          )
          self.lstm = nnx.RNN(cell, broadcast_rngs='recurrent_dropout')
          self.dropout = nnx.Dropout(dropout_rate, rngs=rngs)
          self.dense = nnx.Linear(
            in_features=hidden_features, out_features=1, rngs=rngs
          )

        def __call__(self, x):
          x = self.lstm(x)
          x = self.dropout(x)
          x = x[:, -1, :]  # Use only the final hidden state
          return self.dense(x)

>     model = RNNWithRecurrentDropout(
        in_features=32,
        hidden_features=64,
        dropout_rate=0.2,
        recurrent_dropout_rate=0.1,
        rngs=nnx.Rngs(0, recurrent_dropout=1),
      )

tests/nnx/nn/recurrent_test.py:628:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:143: in __call__
    return _graph_node_meta_call(cls, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:152: in _graph_node_meta_call
    cls._object_meta_construct(node, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:146: in _object_meta_construct
    self.__init__(*args, **kwargs)
tests/nnx/nn/recurrent_test.py:610: in __init__
    cell = LSTMWithRecurrentDropout(
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:143: in __call__
    return _graph_node_meta_call(cls, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:152: in _graph_node_meta_call
    cls._object_meta_construct(node, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:146: in _object_meta_construct
    self.__init__(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = LSTMWithRecurrentDropout()
rngs = Rngs( # RngState: 4 (24 B)
  recurrent_dropout=RngStream( # RngState: 2 (12 B)
    tag='recurrent_dropout',
    key=Rn...="'default'"
    ),
    count=RngCount( # 1 (4 B)
      value=Array(0, dtype=uint32),
      tag="'default'"
    )
  )
)
in_features = 32, hidden_features = 64, dropout_rate = 0.1, kwargs = {}

    def __init__(
      self,
      *,
      rngs: nnx.Rngs,
      in_features: int,
      hidden_features: int,
      dropout_rate: float,
      **kwargs,
    ):
>     super().__init__(
        in_features=in_features,
        hidden_features=hidden_features,
        rngs=rngs,
        keep_rngs=True,
        **kwargs,
      )
E     TypeError: OptimizedLSTMCell.__init__() got an unexpected keyword argument 'keep_rngs'

tests/nnx/nn/recurrent_test.py:583: TypeError
__________________ TestStochastic.test_dropout_internal_rngs ___________________

self = <stochastic_test.TestStochastic object at 0x7f5b6c2236d0>

    def test_dropout_internal_rngs(self):
      n = 0
      m1 = nnx.Dropout(rate=0.5, deterministic=False, rngs=nnx.Rngs(dropout=0))
      m2 = nnx.Dropout(rate=0.5, deterministic=False)
      rngs2 = nnx.Rngs(dropout=0).fork()

      @nnx.jit
      def f(m, x, rngs=None):
        nonlocal n
        n += 1
        return m(x, rngs=rngs)

      x = jnp.ones((1, 10))
>     assert m1.rngs is not None and m1.rngs.count.value == 0

tests/nnx/nn/stochastic_test.py:38:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/rnglib.py:227: in __getattr__
    return self._get_stream(name, AttributeError)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = Rngs( # RngState: 2 (12 B)
  dropout=RngStream( # RngState: 2 (12 B)
    tag='dropout',
    key=RngKey( # 1 (8 B)
    ...="'dropout'"
    ),
    count=RngCount( # 1 (4 B)
      value=Array(0, dtype=uint32),
      tag="'dropout'"
    )
  )
)
name = 'count', error_type = <class 'AttributeError'>

    def _get_stream(self, name: str, error_type: type[Exception]) -> RngStream:
      rngs_vars = vars(self)
      if name not in rngs_vars:
        if 'default' not in rngs_vars:
>         raise error_type(f"No RNG named {name!r} or 'default' found in Rngs.")
E         AttributeError: No RNG named 'count' or 'default' found in Rngs.

/usr/local/lib/python3.10/dist-packages/flax/nnx/rnglib.py:216: AttributeError
___________________ TestStochastic.test_dropout_rng_override ___________________

self = <stochastic_test.TestStochastic object at 0x7f5b6c2217e0>

    def test_dropout_rng_override(self):
      m1 = nnx.Dropout(rate=0.5, deterministic=False, rngs=nnx.Rngs(dropout=0))
      m2 = nnx.Dropout(rate=0.5, deterministic=False, rngs=nnx.Rngs(dropout=1))
      x = jnp.ones((1, 10))

      y1 = m1(x)
      y2 = m2(x)
      with pytest.raises(AssertionError):
        np.testing.assert_allclose(y1, y2)

      y2 = m2(x, rngs=nnx.Rngs(dropout=0).fork())
>     np.testing.assert_allclose(y1, y2)
E     AssertionError:
E     Not equal to tolerance rtol=1e-07, atol=0
E
E     Mismatched elements: 7 / 10 (70%)
E     Max absolute difference among violations: 2.
E     Max relative difference among violations: 1.
E      ACTUAL: array([[0., 2., 2., 2., 2., 0., 0., 2., 0., 2.]], dtype=float32)
E      DESIRED: array([[2., 0., 2., 0., 2., 2., 2., 0., 2., 2.]], dtype=float32)

tests/nnx/nn/stochastic_test.py:67: AssertionError
___________________________ TestOptimizer.test_jit0 ____________________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_jit0>
module_cls = <class 'flax.nnx.nn.linear.Linear'>
jit_decorator = <function TestOptimizer.<lambda> at 0x7f5b6c328940>
optimizer = <function sgd at 0x7f5bbe338700>

    @parameterized.product(
      module_cls=[nnx.Linear, Model],
      jit_decorator=[lambda f: f, nnx.jit, jax.jit],
      optimizer=[optax.sgd, optax.adam],
    )
    def test_jit(self, module_cls, jit_decorator, optimizer):
      x = jax.random.normal(jax.random.key(0), (1, 2))
      y = jnp.ones((1, 4))
      model = module_cls(2, 4, rngs=nnx.Rngs(0))
      tx = optimizer(
          1e-3
      )  # TODO: this doesn't work with adam optimizer for some reason
>     state = nnx.ModelAndOptimizer(model, tx)
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:112: AttributeError
___________________________ TestOptimizer.test_jit1 ____________________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_jit1>
module_cls = <class 'flax.nnx.nn.linear.Linear'>
jit_decorator = <function TestOptimizer.<lambda> at 0x7f5b6c328940>
optimizer = <function adam at 0x7f5bbe31bd00>

    @parameterized.product(
      module_cls=[nnx.Linear, Model],
      jit_decorator=[lambda f: f, nnx.jit, jax.jit],
      optimizer=[optax.sgd, optax.adam],
    )
    def test_jit(self, module_cls, jit_decorator, optimizer):
      x = jax.random.normal(jax.random.key(0), (1, 2))
      y = jnp.ones((1, 4))
      model = module_cls(2, 4, rngs=nnx.Rngs(0))
      tx = optimizer(
          1e-3
      )  # TODO: this doesn't work with adam optimizer for some reason
>     state = nnx.ModelAndOptimizer(model, tx)
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:112: AttributeError
___________________________ TestOptimizer.test_jit10 ___________________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_jit10>
module_cls = <class 'nnx.optimizer_test.Model'>
jit_decorator = <function jit at 0x7f5bbf4f6b00>
optimizer = <function sgd at 0x7f5bbe338700>

    @parameterized.product(
      module_cls=[nnx.Linear, Model],
      jit_decorator=[lambda f: f, nnx.jit, jax.jit],
      optimizer=[optax.sgd, optax.adam],
    )
    def test_jit(self, module_cls, jit_decorator, optimizer):
      x = jax.random.normal(jax.random.key(0), (1, 2))
      y = jnp.ones((1, 4))
      model = module_cls(2, 4, rngs=nnx.Rngs(0))
      tx = optimizer(
          1e-3
      )  # TODO: this doesn't work with adam optimizer for some reason
>     state = nnx.ModelAndOptimizer(model, tx)
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:112: AttributeError
___________________________ TestOptimizer.test_jit11 ___________________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_jit11>
module_cls = <class 'nnx.optimizer_test.Model'>
jit_decorator = <function jit at 0x7f5bbf4f6b00>
optimizer = <function adam at 0x7f5bbe31bd00>

    @parameterized.product(
      module_cls=[nnx.Linear, Model],
      jit_decorator=[lambda f: f, nnx.jit, jax.jit],
      optimizer=[optax.sgd, optax.adam],
    )
    def test_jit(self, module_cls, jit_decorator, optimizer):
      x = jax.random.normal(jax.random.key(0), (1, 2))
      y = jnp.ones((1, 4))
      model = module_cls(2, 4, rngs=nnx.Rngs(0))
      tx = optimizer(
          1e-3
      )  # TODO: this doesn't work with adam optimizer for some reason
>     state = nnx.ModelAndOptimizer(model, tx)
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:112: AttributeError
___________________________ TestOptimizer.test_jit2 ____________________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_jit2>
module_cls = <class 'flax.nnx.nn.linear.Linear'>
jit_decorator = <function jit at 0x7f5bbe691fc0>
optimizer = <function sgd at 0x7f5bbe338700>

    @parameterized.product(
      module_cls=[nnx.Linear, Model],
      jit_decorator=[lambda f: f, nnx.jit, jax.jit],
      optimizer=[optax.sgd, optax.adam],
    )
    def test_jit(self, module_cls, jit_decorator, optimizer):
      x = jax.random.normal(jax.random.key(0), (1, 2))
      y = jnp.ones((1, 4))
      model = module_cls(2, 4, rngs=nnx.Rngs(0))
      tx = optimizer(
          1e-3
      )  # TODO: this doesn't work with adam optimizer for some reason
>     state = nnx.ModelAndOptimizer(model, tx)
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:112: AttributeError
___________________________ TestOptimizer.test_jit3 ____________________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_jit3>
module_cls = <class 'flax.nnx.nn.linear.Linear'>
jit_decorator = <function jit at 0x7f5bbe691fc0>
optimizer = <function adam at 0x7f5bbe31bd00>

    @parameterized.product(
      module_cls=[nnx.Linear, Model],
      jit_decorator=[lambda f: f, nnx.jit, jax.jit],
      optimizer=[optax.sgd, optax.adam],
    )
    def test_jit(self, module_cls, jit_decorator, optimizer):
      x = jax.random.normal(jax.random.key(0), (1, 2))
      y = jnp.ones((1, 4))
      model = module_cls(2, 4, rngs=nnx.Rngs(0))
      tx = optimizer(
          1e-3
      )  # TODO: this doesn't work with adam optimizer for some reason
>     state = nnx.ModelAndOptimizer(model, tx)
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:112: AttributeError
___________________________ TestOptimizer.test_jit4 ____________________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_jit4>
module_cls = <class 'flax.nnx.nn.linear.Linear'>
jit_decorator = <function jit at 0x7f5bbf4f6b00>
optimizer = <function sgd at 0x7f5bbe338700>

    @parameterized.product(
      module_cls=[nnx.Linear, Model],
      jit_decorator=[lambda f: f, nnx.jit, jax.jit],
      optimizer=[optax.sgd, optax.adam],
    )
    def test_jit(self, module_cls, jit_decorator, optimizer):
      x = jax.random.normal(jax.random.key(0), (1, 2))
      y = jnp.ones((1, 4))
      model = module_cls(2, 4, rngs=nnx.Rngs(0))
      tx = optimizer(
          1e-3
      )  # TODO: this doesn't work with adam optimizer for some reason
>     state = nnx.ModelAndOptimizer(model, tx)
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:112: AttributeError
___________________________ TestOptimizer.test_jit5 ____________________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_jit5>
module_cls = <class 'flax.nnx.nn.linear.Linear'>
jit_decorator = <function jit at 0x7f5bbf4f6b00>
optimizer = <function adam at 0x7f5bbe31bd00>

    @parameterized.product(
      module_cls=[nnx.Linear, Model],
      jit_decorator=[lambda f: f, nnx.jit, jax.jit],
      optimizer=[optax.sgd, optax.adam],
    )
    def test_jit(self, module_cls, jit_decorator, optimizer):
      x = jax.random.normal(jax.random.key(0), (1, 2))
      y = jnp.ones((1, 4))
      model = module_cls(2, 4, rngs=nnx.Rngs(0))
      tx = optimizer(
          1e-3
      )  # TODO: this doesn't work with adam optimizer for some reason
>     state = nnx.ModelAndOptimizer(model, tx)
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:112: AttributeError
___________________________ TestOptimizer.test_jit6 ____________________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_jit6>
module_cls = <class 'nnx.optimizer_test.Model'>
jit_decorator = <function TestOptimizer.<lambda> at 0x7f5b6c328940>
optimizer = <function sgd at 0x7f5bbe338700>

    @parameterized.product(
      module_cls=[nnx.Linear, Model],
      jit_decorator=[lambda f: f, nnx.jit, jax.jit],
      optimizer=[optax.sgd, optax.adam],
    )
    def test_jit(self, module_cls, jit_decorator, optimizer):
      x = jax.random.normal(jax.random.key(0), (1, 2))
      y = jnp.ones((1, 4))
      model = module_cls(2, 4, rngs=nnx.Rngs(0))
      tx = optimizer(
          1e-3
      )  # TODO: this doesn't work with adam optimizer for some reason
>     state = nnx.ModelAndOptimizer(model, tx)
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:112: AttributeError
___________________________ TestOptimizer.test_jit7 ____________________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_jit7>
module_cls = <class 'nnx.optimizer_test.Model'>
jit_decorator = <function TestOptimizer.<lambda> at 0x7f5b6c328940>
optimizer = <function adam at 0x7f5bbe31bd00>

    @parameterized.product(
      module_cls=[nnx.Linear, Model],
      jit_decorator=[lambda f: f, nnx.jit, jax.jit],
      optimizer=[optax.sgd, optax.adam],
    )
    def test_jit(self, module_cls, jit_decorator, optimizer):
      x = jax.random.normal(jax.random.key(0), (1, 2))
      y = jnp.ones((1, 4))
      model = module_cls(2, 4, rngs=nnx.Rngs(0))
      tx = optimizer(
          1e-3
      )  # TODO: this doesn't work with adam optimizer for some reason
>     state = nnx.ModelAndOptimizer(model, tx)
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:112: AttributeError
___________________________ TestOptimizer.test_jit8 ____________________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_jit8>
module_cls = <class 'nnx.optimizer_test.Model'>
jit_decorator = <function jit at 0x7f5bbe691fc0>
optimizer = <function sgd at 0x7f5bbe338700>

    @parameterized.product(
      module_cls=[nnx.Linear, Model],
      jit_decorator=[lambda f: f, nnx.jit, jax.jit],
      optimizer=[optax.sgd, optax.adam],
    )
    def test_jit(self, module_cls, jit_decorator, optimizer):
      x = jax.random.normal(jax.random.key(0), (1, 2))
      y = jnp.ones((1, 4))
      model = module_cls(2, 4, rngs=nnx.Rngs(0))
      tx = optimizer(
          1e-3
      )  # TODO: this doesn't work with adam optimizer for some reason
>     state = nnx.ModelAndOptimizer(model, tx)
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:112: AttributeError
___________________________ TestOptimizer.test_jit9 ____________________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_jit9>
module_cls = <class 'nnx.optimizer_test.Model'>
jit_decorator = <function jit at 0x7f5bbe691fc0>
optimizer = <function adam at 0x7f5bbe31bd00>

    @parameterized.product(
      module_cls=[nnx.Linear, Model],
      jit_decorator=[lambda f: f, nnx.jit, jax.jit],
      optimizer=[optax.sgd, optax.adam],
    )
    def test_jit(self, module_cls, jit_decorator, optimizer):
      x = jax.random.normal(jax.random.key(0), (1, 2))
      y = jnp.ones((1, 4))
      model = module_cls(2, 4, rngs=nnx.Rngs(0))
      tx = optimizer(
          1e-3
      )  # TODO: this doesn't work with adam optimizer for some reason
>     state = nnx.ModelAndOptimizer(model, tx)
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:112: AttributeError
______________________ TestOptimizer.test_jit_linesearch0 ______________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_jit_linesearch0>
module_cls = <class 'flax.nnx.nn.linear.Linear'>
jit_decorator = <function TestOptimizer.<lambda> at 0x7f5b6c3289d0>
optimizer = <function lbfgs at 0x7f5bbe339360>

    @parameterized.product(
        module_cls=[nnx.Linear, Model],
        jit_decorator=[lambda f: f, nnx.jit, jax.jit],
        optimizer=[optax.lbfgs],
    )
    def test_jit_linesearch(self, module_cls, jit_decorator, optimizer):
      x = jax.random.normal(jax.random.key(0), (1, 2))
      y = jnp.ones((1, 4))
      model = module_cls(2, 4, rngs=nnx.Rngs(0))
      tx = optimizer(1e-3)
>     state = nnx.ModelAndOptimizer(model, tx)
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:157: AttributeError
______________________ TestOptimizer.test_jit_linesearch1 ______________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_jit_linesearch1>
module_cls = <class 'flax.nnx.nn.linear.Linear'>
jit_decorator = <function jit at 0x7f5bbe691fc0>
optimizer = <function lbfgs at 0x7f5bbe339360>

    @parameterized.product(
        module_cls=[nnx.Linear, Model],
        jit_decorator=[lambda f: f, nnx.jit, jax.jit],
        optimizer=[optax.lbfgs],
    )
    def test_jit_linesearch(self, module_cls, jit_decorator, optimizer):
      x = jax.random.normal(jax.random.key(0), (1, 2))
      y = jnp.ones((1, 4))
      model = module_cls(2, 4, rngs=nnx.Rngs(0))
      tx = optimizer(1e-3)
>     state = nnx.ModelAndOptimizer(model, tx)
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:157: AttributeError
______________________ TestOptimizer.test_jit_linesearch2 ______________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_jit_linesearch2>
module_cls = <class 'flax.nnx.nn.linear.Linear'>
jit_decorator = <function jit at 0x7f5bbf4f6b00>
optimizer = <function lbfgs at 0x7f5bbe339360>

    @parameterized.product(
        module_cls=[nnx.Linear, Model],
        jit_decorator=[lambda f: f, nnx.jit, jax.jit],
        optimizer=[optax.lbfgs],
    )
    def test_jit_linesearch(self, module_cls, jit_decorator, optimizer):
      x = jax.random.normal(jax.random.key(0), (1, 2))
      y = jnp.ones((1, 4))
      model = module_cls(2, 4, rngs=nnx.Rngs(0))
      tx = optimizer(1e-3)
>     state = nnx.ModelAndOptimizer(model, tx)
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:157: AttributeError
______________________ TestOptimizer.test_jit_linesearch3 ______________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_jit_linesearch3>
module_cls = <class 'nnx.optimizer_test.Model'>
jit_decorator = <function TestOptimizer.<lambda> at 0x7f5b6c3289d0>
optimizer = <function lbfgs at 0x7f5bbe339360>

    @parameterized.product(
        module_cls=[nnx.Linear, Model],
        jit_decorator=[lambda f: f, nnx.jit, jax.jit],
        optimizer=[optax.lbfgs],
    )
    def test_jit_linesearch(self, module_cls, jit_decorator, optimizer):
      x = jax.random.normal(jax.random.key(0), (1, 2))
      y = jnp.ones((1, 4))
      model = module_cls(2, 4, rngs=nnx.Rngs(0))
      tx = optimizer(1e-3)
>     state = nnx.ModelAndOptimizer(model, tx)
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:157: AttributeError
______________________ TestOptimizer.test_jit_linesearch4 ______________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_jit_linesearch4>
module_cls = <class 'nnx.optimizer_test.Model'>
jit_decorator = <function jit at 0x7f5bbe691fc0>
optimizer = <function lbfgs at 0x7f5bbe339360>

    @parameterized.product(
        module_cls=[nnx.Linear, Model],
        jit_decorator=[lambda f: f, nnx.jit, jax.jit],
        optimizer=[optax.lbfgs],
    )
    def test_jit_linesearch(self, module_cls, jit_decorator, optimizer):
      x = jax.random.normal(jax.random.key(0), (1, 2))
      y = jnp.ones((1, 4))
      model = module_cls(2, 4, rngs=nnx.Rngs(0))
      tx = optimizer(1e-3)
>     state = nnx.ModelAndOptimizer(model, tx)
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:157: AttributeError
______________________ TestOptimizer.test_jit_linesearch5 ______________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_jit_linesearch5>
module_cls = <class 'nnx.optimizer_test.Model'>
jit_decorator = <function jit at 0x7f5bbf4f6b00>
optimizer = <function lbfgs at 0x7f5bbe339360>

    @parameterized.product(
        module_cls=[nnx.Linear, Model],
        jit_decorator=[lambda f: f, nnx.jit, jax.jit],
        optimizer=[optax.lbfgs],
    )
    def test_jit_linesearch(self, module_cls, jit_decorator, optimizer):
      x = jax.random.normal(jax.random.key(0), (1, 2))
      y = jnp.ones((1, 4))
      model = module_cls(2, 4, rngs=nnx.Rngs(0))
      tx = optimizer(1e-3)
>     state = nnx.ModelAndOptimizer(model, tx)
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:157: AttributeError
_________________________ TestOptimizer.test_metrics0 __________________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_metrics0>
module_cls = <class 'flax.nnx.nn.linear.Linear'>
optimizer = <function sgd at 0x7f5bbe338700>

    @parameterized.product(
        module_cls=[nnx.Linear, Model],
        optimizer=[optax.sgd, optax.adam],
    )
    def test_metrics(self, module_cls, optimizer):
>     class TrainState(nnx.ModelAndOptimizer):
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:208: AttributeError
_________________________ TestOptimizer.test_metrics1 __________________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_metrics1>
module_cls = <class 'flax.nnx.nn.linear.Linear'>
optimizer = <function adam at 0x7f5bbe31bd00>

    @parameterized.product(
        module_cls=[nnx.Linear, Model],
        optimizer=[optax.sgd, optax.adam],
    )
    def test_metrics(self, module_cls, optimizer):
>     class TrainState(nnx.ModelAndOptimizer):
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:208: AttributeError
_________________________ TestOptimizer.test_metrics2 __________________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_metrics2>
module_cls = <class 'nnx.optimizer_test.Model'>
optimizer = <function sgd at 0x7f5bbe338700>

    @parameterized.product(
        module_cls=[nnx.Linear, Model],
        optimizer=[optax.sgd, optax.adam],
    )
    def test_metrics(self, module_cls, optimizer):
>     class TrainState(nnx.ModelAndOptimizer):
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:208: AttributeError
_________________________ TestOptimizer.test_metrics3 __________________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_metrics3>
module_cls = <class 'nnx.optimizer_test.Model'>
optimizer = <function adam at 0x7f5bbe31bd00>

    @parameterized.product(
        module_cls=[nnx.Linear, Model],
        optimizer=[optax.sgd, optax.adam],
    )
    def test_metrics(self, module_cls, optimizer):
>     class TrainState(nnx.ModelAndOptimizer):
E     AttributeError: module 'flax.nnx' has no attribute 'ModelAndOptimizer'

tests/nnx/optimizer_test.py:208: AttributeError
___________________ TestOptimizer.test_sharding_propagation ____________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_sharding_propagation>

    def test_sharding_propagation(self):
      with set_mesh(jax.make_mesh(((1, 1)), ('a', 'b'))):
        model = nnx.Linear(
            2,
            3,
            rngs=nnx.Rngs(0),
            kernel_init=nnx.with_partitioning(
                nnx.initializers.lecun_normal(),
                sharding=('a', 'b'),
            ),
            use_bias=False,
        )
        optimizer = nnx.Optimizer(model, optax.adamw(0.1), wrt=nnx.Param)

      state = nnx.state(optimizer)
      partition_spec = nnx.get_partition_spec(state)

>     self.assertEqual(state['opt_state'][0]['mu']['kernel'].sharding_names, ('a', 'b'))

tests/nnx/optimizer_test.py:94:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = VariableState( # 6 (24 B)
  type=OptVariable,
  value=Array([[0., 0., 0.],
         [0., 0., 0.]], dtype=float32),
  sharding=('a', 'b'),
  mesh=None,
  source_type=Param
)
name = 'sharding_names'

    def __getattr__(self, name: str) -> None:
      var_metadata = object.__getattribute__(self, '_var_metadata')
      if name not in var_metadata:
>       raise AttributeError(f"'VariableState' object has no attribute '{name}'")
E       AttributeError: 'VariableState' object has no attribute 'sharding_names'

/usr/local/lib/python3.10/dist-packages/flax/nnx/variablelib.py:986: AttributeError
__________________________ TestOptimizer.test_update ___________________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_update>

    def test_update(self):
      model = nnx.Linear(2, 3, rngs=nnx.Rngs(0))
      optimizer = nnx.Optimizer(model, optax.adamw(0.1), wrt=nnx.Param)

      def loss_fn(model):
        params = nnx.state(model)
        loss = sum(jnp.sum(x**2) for x in jax.tree.leaves(params))
        return loss

      grads = nnx.grad(loss_fn)(model)
>     optimizer.update(model, grads)
E     TypeError: Optimizer.update() takes 2 positional arguments but 3 were given

tests/nnx/optimizer_test.py:75: TypeError
________________________ TestOptimizer.test_wrt_update0 ________________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_wrt_update0>
variable = <class 'flax.nnx.variablelib.Param'>

    @parameterized.parameters(
        {'variable': nnx.Param},
        {'variable': nnx.LoRAParam},
        {'variable': (nnx.Param, nnx.LoRAParam)},
    )
    def test_wrt_update(self, variable):
      in_features = 4
      out_features = 10
      model = nnx.LoRA(
          in_features=in_features,
          lora_rank=2,
          out_features=out_features,
          base_module=Model(
              in_features=in_features, out_features=out_features, rngs=nnx.Rngs(0)
          ),
          rngs=nnx.Rngs(1),
      )
      state = nnx.Optimizer(model, optax.adam(1e-3), wrt=variable)
      prev_variables, prev_other_variables = nnx.clone(nnx.state(model, variable, ...))

      x = jnp.ones((1, 4))
      y = jnp.ones((1, 10))
      loss_fn = lambda model, x, y: ((model(x) - y) ** 2).mean()
      grad_fn = nnx.grad(loss_fn, argnums=nnx.DiffState(0, variable))

      def step():
        grads = grad_fn(model, x, y)
        initial_loss = loss_fn(model, x, y)
        state.update(model, grads)
        self.assertTrue(loss_fn(model, x, y) < initial_loss)

      # Since lora_b is initialized to zeros by default, the gradient flow to lora_a
      # will be zeroed out in first call. Thus, run the step twice to make sure
      # lora_a is updated.
      for _ in range(2):
>       step()

tests/nnx/optimizer_test.py:267:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    def step():
      grads = grad_fn(model, x, y)
      initial_loss = loss_fn(model, x, y)
>     state.update(model, grads)
E     TypeError: Optimizer.update() takes 2 positional arguments but 3 were given

tests/nnx/optimizer_test.py:260: TypeError
________________________ TestOptimizer.test_wrt_update1 ________________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_wrt_update1>
variable = <class 'flax.nnx.nn.lora.LoRAParam'>

    @parameterized.parameters(
        {'variable': nnx.Param},
        {'variable': nnx.LoRAParam},
        {'variable': (nnx.Param, nnx.LoRAParam)},
    )
    def test_wrt_update(self, variable):
      in_features = 4
      out_features = 10
      model = nnx.LoRA(
          in_features=in_features,
          lora_rank=2,
          out_features=out_features,
          base_module=Model(
              in_features=in_features, out_features=out_features, rngs=nnx.Rngs(0)
          ),
          rngs=nnx.Rngs(1),
      )
      state = nnx.Optimizer(model, optax.adam(1e-3), wrt=variable)
      prev_variables, prev_other_variables = nnx.clone(nnx.state(model, variable, ...))

      x = jnp.ones((1, 4))
      y = jnp.ones((1, 10))
      loss_fn = lambda model, x, y: ((model(x) - y) ** 2).mean()
      grad_fn = nnx.grad(loss_fn, argnums=nnx.DiffState(0, variable))

      def step():
        grads = grad_fn(model, x, y)
        initial_loss = loss_fn(model, x, y)
        state.update(model, grads)
        self.assertTrue(loss_fn(model, x, y) < initial_loss)

      # Since lora_b is initialized to zeros by default, the gradient flow to lora_a
      # will be zeroed out in first call. Thus, run the step twice to make sure
      # lora_a is updated.
      for _ in range(2):
>       step()

tests/nnx/optimizer_test.py:267:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    def step():
      grads = grad_fn(model, x, y)
      initial_loss = loss_fn(model, x, y)
>     state.update(model, grads)
E     TypeError: Optimizer.update() takes 2 positional arguments but 3 were given

tests/nnx/optimizer_test.py:260: TypeError
________________________ TestOptimizer.test_wrt_update2 ________________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_wrt_update2>
variable = (<class 'flax.nnx.variablelib.Param'>, <class 'flax.nnx.nn.lora.LoRAParam'>)

    @parameterized.parameters(
        {'variable': nnx.Param},
        {'variable': nnx.LoRAParam},
        {'variable': (nnx.Param, nnx.LoRAParam)},
    )
    def test_wrt_update(self, variable):
      in_features = 4
      out_features = 10
      model = nnx.LoRA(
          in_features=in_features,
          lora_rank=2,
          out_features=out_features,
          base_module=Model(
              in_features=in_features, out_features=out_features, rngs=nnx.Rngs(0)
          ),
          rngs=nnx.Rngs(1),
      )
      state = nnx.Optimizer(model, optax.adam(1e-3), wrt=variable)
      prev_variables, prev_other_variables = nnx.clone(nnx.state(model, variable, ...))

      x = jnp.ones((1, 4))
      y = jnp.ones((1, 10))
      loss_fn = lambda model, x, y: ((model(x) - y) ** 2).mean()
      grad_fn = nnx.grad(loss_fn, argnums=nnx.DiffState(0, variable))

      def step():
        grads = grad_fn(model, x, y)
        initial_loss = loss_fn(model, x, y)
        state.update(model, grads)
        self.assertTrue(loss_fn(model, x, y) < initial_loss)

      # Since lora_b is initialized to zeros by default, the gradient flow to lora_a
      # will be zeroed out in first call. Thus, run the step twice to make sure
      # lora_a is updated.
      for _ in range(2):
>       step()

tests/nnx/optimizer_test.py:267:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    def step():
      grads = grad_fn(model, x, y)
      initial_loss = loss_fn(model, x, y)
>     state.update(model, grads)
E     TypeError: Optimizer.update() takes 2 positional arguments but 3 were given

tests/nnx/optimizer_test.py:260: TypeError
__________________ TestOptimizer.test_wrt_update_linesearch0 ___________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_wrt_update_linesearch0>
variable = <class 'flax.nnx.variablelib.Param'>

    @parameterized.parameters(
        {'variable': nnx.Param},
        # {'variable': nnx.LoRAParam},
        {'variable': (nnx.Param, nnx.LoRAParam)},
    )
    def test_wrt_update_linesearch(self, variable):
      in_features = 4
      out_features = 10
      model = nnx.LoRA(
          in_features=in_features,
          lora_rank=2,
          out_features=out_features,
          base_module=Model(
              in_features=in_features, out_features=out_features, rngs=nnx.Rngs(0)
          ),
          rngs=nnx.Rngs(1),
      )
      state = nnx.Optimizer(model, optax.lbfgs(), wrt=variable)
      prev_variables, prev_other_variables = nnx.clone(nnx.state(model, variable, ...))

      x = jnp.ones((1, 4))
      y = jnp.ones((1, 10))
      loss_fn = lambda model, x, y: ((model(x) - y) ** 2).mean()

      grad_fn = nnx.grad(loss_fn, argnums=nnx.DiffState(0, variable))
      graphdef = nnx.graphdef(model)
      loss_fn_split = lambda state: loss_fn(nnx.merge(graphdef, state), x, y)

      def step():
        grads = grad_fn(model, x, y)
        initial_loss = loss_fn(model, x, y)
        state.update(
            model, grads, grad=grads, value_fn=loss_fn_split, value=initial_loss
        )
        self.assertTrue(loss_fn(model, x, y) < initial_loss)

      # Since lora_b is initialized to zeros by default, the gradient flow to lora_a
      # will be zeroed out in first call. Thus, run the step twice to make sure
      # lora_a is updated.
      for _ in range(2):
>       step()

tests/nnx/optimizer_test.py:319:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    def step():
      grads = grad_fn(model, x, y)
      initial_loss = loss_fn(model, x, y)
>     state.update(
          model, grads, grad=grads, value_fn=loss_fn_split, value=initial_loss
      )
E     TypeError: Optimizer.update() takes 2 positional arguments but 3 were given

tests/nnx/optimizer_test.py:310: TypeError
__________________ TestOptimizer.test_wrt_update_linesearch1 ___________________

self = <nnx.optimizer_test.TestOptimizer testMethod=test_wrt_update_linesearch1>
variable = (<class 'flax.nnx.variablelib.Param'>, <class 'flax.nnx.nn.lora.LoRAParam'>)

    @parameterized.parameters(
        {'variable': nnx.Param},
        # {'variable': nnx.LoRAParam},
        {'variable': (nnx.Param, nnx.LoRAParam)},
    )
    def test_wrt_update_linesearch(self, variable):
      in_features = 4
      out_features = 10
      model = nnx.LoRA(
          in_features=in_features,
          lora_rank=2,
          out_features=out_features,
          base_module=Model(
              in_features=in_features, out_features=out_features, rngs=nnx.Rngs(0)
          ),
          rngs=nnx.Rngs(1),
      )
      state = nnx.Optimizer(model, optax.lbfgs(), wrt=variable)
      prev_variables, prev_other_variables = nnx.clone(nnx.state(model, variable, ...))

      x = jnp.ones((1, 4))
      y = jnp.ones((1, 10))
      loss_fn = lambda model, x, y: ((model(x) - y) ** 2).mean()

      grad_fn = nnx.grad(loss_fn, argnums=nnx.DiffState(0, variable))
      graphdef = nnx.graphdef(model)
      loss_fn_split = lambda state: loss_fn(nnx.merge(graphdef, state), x, y)

      def step():
        grads = grad_fn(model, x, y)
        initial_loss = loss_fn(model, x, y)
        state.update(
            model, grads, grad=grads, value_fn=loss_fn_split, value=initial_loss
        )
        self.assertTrue(loss_fn(model, x, y) < initial_loss)

      # Since lora_b is initialized to zeros by default, the gradient flow to lora_a
      # will be zeroed out in first call. Thus, run the step twice to make sure
      # lora_a is updated.
      for _ in range(2):
>       step()

tests/nnx/optimizer_test.py:319:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

    def step():
      grads = grad_fn(model, x, y)
      initial_loss = loss_fn(model, x, y)
>     state.update(
          model, grads, grad=grads, value_fn=loss_fn_split, value=initial_loss
      )
E     TypeError: Optimizer.update() takes 2 positional arguments but 3 were given

tests/nnx/optimizer_test.py:310: TypeError
___________________ TestRngs.test_fallback_error_no_default ____________________
AttributeError: No RNG named 'dropout' or 'default' found in Rngs.

During handling of the above exception, another exception occurred:

self = <nnx.rngs_test.TestRngs testMethod=test_fallback_error_no_default>

    def test_fallback_error_no_default(self):
      rngs = nnx.Rngs(some_name=0)
>     with self.assertRaisesRegex(AttributeError, 'No RngStream named'):
E     AssertionError: "No RngStream named" does not match "No RNG named 'dropout' or 'default' found in Rngs."

tests/nnx/rngs_test.py:38: AssertionError
_________________________ TestRngs.test_random_helpers _________________________

self = <nnx.rngs_test.TestRngs testMethod=test_random_helpers>

    def test_random_helpers(self):
      rngs = nnx.Rngs(0)

>     x1 = rngs.normal((2, 3))
E     TypeError: RngStream.__call__() takes 1 positional argument but 2 were given

tests/nnx/rngs_test.py:198: TypeError
__________________ TestSPMD.test_add_remove_axis_in_transform __________________

self = <nnx.spmd_test.TestSPMD testMethod=test_add_remove_axis_in_transform>

    def test_add_remove_axis_in_transform(self):
      test = self
      kadds, kremoves, badds, bremoves = [], [], [], []
      class MLP(nnx.Module):

        @nnx.split_rngs(splits=5)
        @nnx.vmap(
            in_axes=(0, 0),
            transform_metadata={nnx.PARTITION_NAME: 'layers', 'nickname': 'nick'},
        )
        def __init__(self, rngs: nnx.Rngs):
          self.linear = nnx.Linear(
            3,
            3,
            kernel_init=nnx.with_metadata(
              nnx.initializers.lecun_normal(),
              sharding_names=('din', 'dout'),
              nickname=('in', 'out'),
              on_add_axis=lambda _, idx, name: kadds.append((idx, name)),
              on_remove_axis=lambda _, idx, name: kremoves.append((idx, name)),
            ),
            bias_init=nnx.with_metadata(
              nnx.initializers.zeros_init(),  # no sharding annotation here!
              on_add_axis=lambda _, idx, name: badds.append((idx, name)),
              on_remove_axis=lambda _, idx, name: bremoves.append((idx, name)),
            ),
            rngs=rngs,
          )

        @nnx.scan(
            in_axes=(0, nnx.Carry),
            transform_metadata={nnx.PARTITION_NAME: 'layers'}
        )
        def __call__(self, x: jax.Array):
          x = self.linear(x)
          # test sharding layer axes is not present inside scan
          test.assertEqual(self.linear.kernel.shape, (3, 3))
          test.assertEqual(self.linear.kernel.sharding_names, ('din', 'dout'))
          # at least a remove_axis was already called to remove the layer axis
          test.assertEqual(kremoves[-1], (0, 'layers'))
          test.assertEqual(bremoves[-1], (0, 'layers'))
          return x, None

      m = MLP(rngs=nnx.Rngs(0))
      self.assertEqual(m.linear.kernel.shape, (5, 3, 3))
>     self.assertEqual(m.linear.kernel.sharding_names, ('layers', 'din', 'dout'))
E     AssertionError: Tuples differ: ('din', 'dout') != ('layers', 'din', 'dout')
E
E     First differing element 0:
E     'din'
E     'layers'
E
E     Second tuple contains 1 additional elements.
E     First extra element 2:
E     'dout'
E
E     - ('din', 'dout')
E     + ('layers', 'din', 'dout')
E     ?  ++++++++++

tests/nnx/spmd_test.py:125: AssertionError
______________________________ TestSPMD.test_init ______________________________

self = <nnx.spmd_test.TestSPMD testMethod=test_init>

    def test_init(self):
      if jax.device_count() < 4:
        self.skipTest('At least 4 devices required')
      class Foo(nnx.Module):
        def __init__(self):
          self.w = nnx.Param(
            nnx.with_partitioning(
              lambda: jnp.ones((8, 2)),
              sharding=('model', 'data'),
            )()
          )

        def __call__(self, x):
          return x @ self.w

      @jax.jit
      def create_module():
        return nnx.split(Foo())

      mesh = Mesh(mesh_utils.create_device_mesh((2, 2)), ('model', 'data'))

      with mesh:
        m: Foo = nnx.merge(*create_module())  # type: ignore[invalid-annotation]

      assert m.w.shape == (8, 2)
>     assert m.w.sharding.shard_shape(m.w.shape) == (8, 2)
E     AttributeError: 'tuple' object has no attribute 'shard_shape'

tests/nnx/spmd_test.py:53: AttributeError
___________________________ StateTest.test_pure_dict ___________________________

self = <nnx.state_test.StateTest testMethod=test_pure_dict>

    def test_pure_dict(self):
      module = nnx.Linear(4, 5, rngs=nnx.Rngs(0))
      state = nnx.state(module)
      pure_dict = nnx.to_pure_dict(state)
      assert isinstance(pure_dict, dict)
      assert isinstance(pure_dict['kernel'], jax.Array)
      assert isinstance(pure_dict['bias'], jax.Array)
      nnx.replace_by_pure_dict(state, jax.tree.map(jnp.zeros_like, pure_dict))
      assert isinstance(state, nnx.State)
>     assert isinstance(state['kernel'], nnx.Variable)
E     AssertionError: assert False
E      +  where False = isinstance(VariableState( # 20 (80 B)\n  type=Param,\n  value=Array([[0., 0., 0., 0., 0.],\n         [0., 0., 0., 0., 0.],\n         [0., 0., 0., 0., 0.],\n         [0., 0., 0., 0., 0.]], dtype=float32)\n), <class 'flax.nnx.variablelib.Variable'>)
E      +    where <class 'flax.nnx.variablelib.Variable'> = nnx.Variable

tests/nnx/state_test.py:89: AssertionError
__________________________ SummaryTest.test_tabulate ___________________________

self = <nnx.summary_test.SummaryTest testMethod=test_tabulate>

    def test_tabulate(self):
      class Block(nnx.Module):
        def __init__(self, din, dout, rngs: nnx.Rngs):
          self.linear = nnx.Linear(din, dout, rngs=rngs)
          self.bn = nnx.BatchNorm(dout, rngs=rngs)
          self.dropout = nnx.Dropout(0.2, rngs=rngs)

        def forward(self, x):
          return nnx.relu(self.dropout(self.bn(self.linear(x))))

      class Foo(nnx.Module):
        def __init__(self, rngs: nnx.Rngs):
          self.block1 = Block(32, 128, rngs=rngs)
          self.block2 = Block(128, 10, rngs=rngs)

        def __call__(self, x):
          return self.block2.forward(self.block1.forward(x))

      foo = Foo(nnx.Rngs(0))
      x = jnp.ones((1, 32))
      table_repr = nnx.tabulate(
        foo, x, console_kwargs=CONSOLE_TEST_KWARGS
      ).splitlines()

      self.assertIn('Foo Summary', table_repr[0])
      self.assertIn('path', table_repr[2])
      self.assertIn('type', table_repr[2])
      self.assertIn('BatchStat', table_repr[2])
      self.assertIn('Param', table_repr[2])
      self.assertIn('block1/forward', table_repr[6])
      self.assertIn('Block', table_repr[6])
      self.assertIn('block1/linear', table_repr[8])
      self.assertIn('Linear', table_repr[8])
      self.assertIn('block1/bn', table_repr[13])
      self.assertIn('BatchNorm', table_repr[13])
      self.assertIn('block1/dropout', table_repr[18])
      self.assertIn('Dropout', table_repr[18])
      self.assertIn('block2/forward', table_repr[20])
      self.assertIn('Block', table_repr[20])
      self.assertIn('block2/linear', table_repr[22])
      self.assertIn('Linear', table_repr[22])
      self.assertIn('block2/bn', table_repr[27])
      self.assertIn('BatchNorm', table_repr[27])
      self.assertIn('block2/dropout', table_repr[32])
      self.assertIn('Dropout', table_repr[32])

      self.assertIn('Total', table_repr[34])
      self.assertIn('276 (1.1 KB)', table_repr[34])
      self.assertIn('5,790 (23.2 KB)', table_repr[34])
>     self.assertIn('4 (24 B)', table_repr[34])
E     AssertionError: '4 (24 B)' not found in '                                                     Total  276 (1.1 KB)        5,790 (23.2 KB)          2 (12 B) '

tests/nnx/summary_test.py:73: AssertionError
_______________ TestJIT.test_cached_unflatten_add_self_reference _______________

self = <nnx.transforms_test.TestJIT testMethod=test_cached_unflatten_add_self_reference>

    def test_cached_unflatten_add_self_reference(self):
      n = 0

      class Foo(nnx.Module):
        def __init__(self):
          self.ref: tp.Optional[Foo] = nnx.data(None)  # type: ignore[name-error]

      @nnx.jit
      def f(m: Foo):
        nonlocal n
        n += 1
        m.ref = m

>     m = Foo()

tests/nnx/transforms_test.py:321:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:143: in __call__
    return _graph_node_meta_call(cls, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:152: in _graph_node_meta_call
    cls._object_meta_construct(node, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:146: in _object_meta_construct
    self.__init__(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = Foo()

    def __init__(self):
>     self.ref: tp.Optional[Foo] = nnx.data(None)  # type: ignore[name-error]
E     AttributeError: module 'flax.nnx' has no attribute 'data'

tests/nnx/transforms_test.py:313: AttributeError
_________________ TestJIT.test_cached_unflatten_ref_in_output __________________

self = <nnx.transforms_test.TestJIT testMethod=test_cached_unflatten_ref_in_output>

    def test_cached_unflatten_ref_in_output(self):
      n = 0

      class Foo(nnx.Module):
        def __init__(self):
          self.ref: tp.Optional[Foo] = nnx.data(None)  # type: ignore[name-error]

      @nnx.jit
      def f(m: Foo):
        nonlocal n
        n += 1
        m.ref = m
        return m

>     m = Foo()

tests/nnx/transforms_test.py:352:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:143: in __call__
    return _graph_node_meta_call(cls, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:152: in _graph_node_meta_call
    cls._object_meta_construct(node, *args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/object.py:146: in _object_meta_construct
    self.__init__(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = Foo()

    def __init__(self):
>     self.ref: tp.Optional[Foo] = nnx.data(None)  # type: ignore[name-error]
E     AttributeError: module 'flax.nnx' has no attribute 'data'

tests/nnx/transforms_test.py:343: AttributeError
___________________ TestJIT.test_mutable_array_input_output ____________________

self = <nnx.transforms_test.TestJIT testMethod=test_mutable_array_input_output>

    def test_mutable_array_input_output(self):
>     m = nnx.array_ref(jnp.array(1.0))
E     AttributeError: module 'flax.nnx' has no attribute 'array_ref'

tests/nnx/transforms_test.py:80: AttributeError
_________________ TestEvalShape.test_eval_shape_mutable_array __________________

self = <nnx.transforms_test.TestEvalShape testMethod=test_eval_shape_mutable_array>

    def test_eval_shape_mutable_array(self):
>     with nnx.use_refs(True):
E     AttributeError: module 'flax.nnx' has no attribute 'use_refs'

tests/nnx/transforms_test.py:461: AttributeError
______________________________ TestGrad.test_grad ______________________________

self = <nnx.transforms_test.TestGrad testMethod=test_grad>

    def test_grad(self):
      p1 = nnx.Param(10.0)
      p2 = nnx.Param(20.0)

      m = Dict(
        a=List([p1, p2]),
        b=p1,
        c=7,
        d=5.0,
      )

      @nnx.grad
      def f(m: Dict):
        # sum all params
        return m['a'][0].value + m['a'][1].value + m['b'].value

      grads = f(m)

      assert m.a[0] is m.b
      assert isinstance(grads, nnx.State)
      assert grads['a']['0'].value == 2.0
>     assert issubclass(type(grads['a']['0']), nnx.Variable)
E     AssertionError: assert False
E      +  where False = issubclass(<class 'flax.nnx.variablelib.VariableState'>, <class 'flax.nnx.variablelib.Variable'>)
E      +    where <class 'flax.nnx.variablelib.VariableState'> = type(VariableState( # 1 (4 B)\n  type=Param,\n  value=Array(2., dtype=float32, weak_type=True)\n))
E      +    and   <class 'flax.nnx.variablelib.Variable'> = nnx.Variable

tests/nnx/transforms_test.py:636: AssertionError
__________________ TestGrad.test_grad_with_multiple_ref_types __________________

self = <nnx.transforms_test.TestGrad testMethod=test_grad_with_multiple_ref_types>

    def test_grad_with_multiple_ref_types(self):
      m = Dict(
        a=List([nnx.Param(10.0), nnx.BatchStat(20.0)]),
        b=nnx.Param(10.0),
        c=7,
        d=5.0,
      )

      @nnx.grad
      def f(m: Dict):
        # sum all params
        return m.a[0].value + m.a[1].value + m.b.value

      grads = f(m)

      assert isinstance(grads, nnx.State)
      assert grads['a']['0'].value == 1.0
>     assert issubclass(type(grads['a']['0']), nnx.Param)
E     AssertionError: assert False
E      +  where False = issubclass(<class 'flax.nnx.variablelib.VariableState'>, <class 'flax.nnx.variablelib.Param'>)
E      +    where <class 'flax.nnx.variablelib.VariableState'> = type(VariableState( # 1 (4 B)\n  type=Param,\n  value=Array(1., dtype=float32, weak_type=True)\n))
E      +    and   <class 'flax.nnx.variablelib.Param'> = nnx.Param

tests/nnx/transforms_test.py:667: AssertionError
____________________ TestGrad.test_grad_with_type_predicate ____________________

self = <nnx.transforms_test.TestGrad testMethod=test_grad_with_type_predicate>

    def test_grad_with_type_predicate(self):
      m = Dict(
        a=List([nnx.Param(10.0), nnx.BatchStat(20.0)]),
        b=nnx.Param(10.0),
        c=7,
        d=5.0,
      )

      @nnx.grad(argnums=nnx.DiffState(0, nnx.BatchStat))
      def f(m: Dict):
        # sum all params
        return m.a[0].value + m.a[1].value + m.b.value

      grads = f(m)

      assert isinstance(grads, nnx.State)
      assert grads['a']['1'].value == 1.0
>     assert issubclass(type(grads['a']['1']), nnx.BatchStat)
E     AssertionError: assert False
E      +  where False = issubclass(<class 'flax.nnx.variablelib.VariableState'>, <class 'flax.nnx.variablelib.BatchStat'>)
E      +    where <class 'flax.nnx.variablelib.VariableState'> = type(VariableState( # 1 (4 B)\n  type=BatchStat,\n  value=Array(1., dtype=float32, weak_type=True)\n))
E      +    and   <class 'flax.nnx.variablelib.BatchStat'> = nnx.BatchStat

tests/nnx/transforms_test.py:695: AssertionError
____________________ TestGrad.test_value_and_grad_with_aux _____________________

self = <nnx.transforms_test.TestGrad testMethod=test_value_and_grad_with_aux>

    def test_value_and_grad_with_aux(self):
      m1 = nnx.Linear(2, 3, rngs=nnx.Rngs(0))
      m2 = nnx.Linear(2, 3, rngs=nnx.Rngs(1))

      m1_diffstate = nnx.DiffState(0, nnx.PathContains('kernel'))
      m2_diffstate = nnx.DiffState(1, nnx.PathContains('bias'))

      @nnx.value_and_grad(argnums=(m1_diffstate, m2_diffstate), has_aux=True)
      def loss_fn(l1: list[nnx.Linear], l2: list[nnx.Linear]):
        loss = jnp.mean(l1[0].kernel * l2[0].kernel) + jnp.mean(
          l1[0].bias * l2[0].bias
        )
        l1[0].kernel[...] = jnp.array(-1.0)
        m3 = nnx.Linear(2, 3, rngs=nnx.Rngs(2))
        return loss, m3

      (loss, m3), (grads_m1, grads_m2) = loss_fn([m1], [m2])

>     self.assertEqual(m1.kernel.value, -1.0)

tests/nnx/transforms_test.py:828:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/jax/_src/array.py:305: in __bool__
    core.check_bool_conversion(self)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

arr = Array([[ True,  True,  True],
       [ True,  True,  True]], dtype=bool)

    def check_bool_conversion(arr: Array):
      if arr.size == 0:
        raise ValueError("The truth value of an empty array is ambiguous. Use"
                         " `array.size > 0` to check that an array is not empty.")
      if arr.size > 1:
>       raise ValueError("The truth value of an array with more than one element"
                         " is ambiguous. Use a.any() or a.all()")
E       ValueError: The truth value of an array with more than one element is ambiguous. Use a.any() or a.all()

/usr/local/lib/python3.10/dist-packages/jax/_src/core.py:765: ValueError
_______________________ TestGrad.test_variables_in_grad ________________________

self = <nnx.transforms_test.TestGrad testMethod=test_variables_in_grad>

    def test_variables_in_grad(self):
      p1 = nnx.Param(10.0)
      p2 = nnx.Param(20.0)

      m = dict(a=[p1, p2], b=p1)

      @nnx.grad
      def f(m: dict):
        # sum all params
        return m['a'][0].value + m['a'][1].value + m['b'].value

      grads = f(m)

      assert m['a'][0] is m['b']
      assert isinstance(grads, dict)
>     assert issubclass(type(grads['a'][0]), nnx.Variable)
E     AssertionError: assert False
E      +  where False = issubclass(<class 'flax.nnx.variablelib.VariableState'>, <class 'flax.nnx.variablelib.Variable'>)
E      +    where <class 'flax.nnx.variablelib.VariableState'> = type(VariableState( # 1 (4 B)\n  type=Param,\n  value=Array(2., dtype=float32, weak_type=True)\n))
E      +    and   <class 'flax.nnx.variablelib.Variable'> = nnx.Variable

tests/nnx/transforms_test.py:851: AssertionError
______________________ TestScan.test_cache_tracing_object ______________________

self = <nnx.transforms_test.TestScan testMethod=test_cache_tracing_object>

    def test_cache_tracing_object(self):
      n = 0
      x = jnp.arange(5)
      count = jnp.array(0)

>     class Foo(nnx.Pytree):
E     AttributeError: module 'flax.nnx' has no attribute 'Pytree'

tests/nnx/transforms_test.py:1774: AttributeError
____________________________ TestScan.test_complex _____________________________
jax.errors.SimplifiedTraceback: For simplicity, JAX has removed its internal frames from the traceback of the following exception. Set JAX_TRACEBACK_FILTERING=off to include these.

The above exception was the direct cause of the following exception:

self = <nnx.transforms_test.TestScan testMethod=test_complex>

    def test_complex(self):
      state_axes = nnx.StateAxes({(nnx.Param, nnx.RngState): 0, ...: None})

      class MLP(nnx.Module):
        @nnx.split_rngs(splits=5)
        @nnx.vmap(in_axes=(state_axes, state_axes))
        def __init__(self, rngs: nnx.Rngs):
          self.linear = nnx.Linear(3, 3, rngs=rngs)
          self.bn = nnx.BatchNorm(3, rngs=rngs)
          self.dropout = nnx.Dropout(0.5, rngs=rngs)
          self.node = nnx.Variable(jnp.ones((2,)))

        @nnx.scan(in_axes=(state_axes, nnx.Carry))
        def __call__(self, x: jax.Array):
          x = self.linear(x)
          x = self.bn(x)
          x = self.dropout(x)
          x = nnx.gelu(x)
          return x, None

      module = MLP(rngs=nnx.Rngs(0))
      module.set_attributes(deterministic=False, use_running_average=False)

      assert module.linear.kernel.value.shape == (5, 3, 3)
      assert module.linear.bias.value.shape == (5, 3)
      assert module.node.value.shape == (2,)

      x = jnp.ones((1, 3))
>     y, _ = module(x)

tests/nnx/transforms_test.py:1621:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/graph.py:2051: in update_context_manager_wrapper
    return f(*args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/transforms/iteration.py:1213: in scan_wrapper
    pure_args: tuple = extract.to_tree(
/usr/local/lib/python3.10/dist-packages/flax/nnx/extract.py:237: in to_tree
    tree_node = split_fn(split_ctx, keypath, leaf_prefix, leaf)
/usr/local/lib/python3.10/dist-packages/flax/nnx/transforms/iteration.py:720: in _scan_split_in
    state = jax.tree.map(lambda x: jnp.moveaxis(x, axis, 0), state)
/usr/local/lib/python3.10/dist-packages/jax/_src/tree.py:155: in map
    return tree_util.tree_map(f, tree, *rest, is_leaf=is_leaf)
/usr/local/lib/python3.10/dist-packages/jax/_src/tree_util.py:362: in tree_map
    return treedef.unflatten(f(*xs) for xs in zip(*all_leaves))
/usr/local/lib/python3.10/dist-packages/jax/_src/tree_util.py:362: in <genexpr>
    return treedef.unflatten(f(*xs) for xs in zip(*all_leaves))
/usr/local/lib/python3.10/dist-packages/flax/nnx/transforms/iteration.py:720: in <lambda>
    state = jax.tree.map(lambda x: jnp.moveaxis(x, axis, 0), state)
/usr/local/lib/python3.10/dist-packages/jax/_src/numpy/lax_numpy.py:2522: in moveaxis
    return _moveaxis(arr, _ensure_index_tuple(source),
/usr/local/lib/python3.10/dist-packages/jax/_src/numpy/lax_numpy.py:2527: in _moveaxis
    source = tuple(_canonicalize_axis(i, np.ndim(a)) for i in source)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

.0 = <tuple_iterator object at 0x7f56570fdd50>

>   source = tuple(_canonicalize_axis(i, np.ndim(a)) for i in source)
E   ValueError: axis 0 is out of bounds for array of dimension 0

/usr/local/lib/python3.10/dist-packages/jax/_src/numpy/lax_numpy.py:2527: ValueError
_______________________ TestScan.test_complex_decorator ________________________
jax.errors.SimplifiedTraceback: For simplicity, JAX has removed its internal frames from the traceback of the following exception. Set JAX_TRACEBACK_FILTERING=off to include these.

The above exception was the direct cause of the following exception:

self = <nnx.transforms_test.TestScan testMethod=test_complex_decorator>

    def test_complex_decorator(self):
      state_axes = nnx.StateAxes({(nnx.Param, nnx.RngState): 0, ...: None})

      class Block(nnx.Module):
        @nnx.split_rngs(splits=5)
        @nnx.vmap(in_axes=(state_axes, state_axes), axis_size=5)
        def __init__(self, rngs: nnx.Rngs):
          self.d = 3
          self.linear = nnx.Linear(3, 3, rngs=rngs)
          self.bn = nnx.BatchNorm(3, rngs=rngs)
          self.dropout = nnx.Dropout(0.5, rngs=rngs)
          self.node = nnx.Variable(jnp.ones((2,)))

        @nnx.scan(in_axes=(state_axes, nnx.Carry))
        def __call__(self, x: jax.Array):
          x = self.linear(x)
          x = self.bn(x)
          x = self.dropout(x)
          x = nnx.gelu(x)
          return x, None

      module = Block(rngs=nnx.Rngs(0))
      module.set_attributes(deterministic=False, use_running_average=False)

      assert module.d == 3
      assert module.linear.kernel.value.shape == (5, 3, 3)
      assert module.linear.bias.value.shape == (5, 3)
      assert module.node.value.shape == (2,)

      x = jnp.ones((1, 3))
>     y, out = module(x)

tests/nnx/transforms_test.py:1688:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/graph.py:2051: in update_context_manager_wrapper
    return f(*args, **kwargs)
/usr/local/lib/python3.10/dist-packages/flax/nnx/transforms/iteration.py:1213: in scan_wrapper
    pure_args: tuple = extract.to_tree(
/usr/local/lib/python3.10/dist-packages/flax/nnx/extract.py:237: in to_tree
    tree_node = split_fn(split_ctx, keypath, leaf_prefix, leaf)
/usr/local/lib/python3.10/dist-packages/flax/nnx/transforms/iteration.py:720: in _scan_split_in
    state = jax.tree.map(lambda x: jnp.moveaxis(x, axis, 0), state)
/usr/local/lib/python3.10/dist-packages/jax/_src/tree.py:155: in map
    return tree_util.tree_map(f, tree, *rest, is_leaf=is_leaf)
/usr/local/lib/python3.10/dist-packages/jax/_src/tree_util.py:362: in tree_map
    return treedef.unflatten(f(*xs) for xs in zip(*all_leaves))
/usr/local/lib/python3.10/dist-packages/jax/_src/tree_util.py:362: in <genexpr>
    return treedef.unflatten(f(*xs) for xs in zip(*all_leaves))
/usr/local/lib/python3.10/dist-packages/flax/nnx/transforms/iteration.py:720: in <lambda>
    state = jax.tree.map(lambda x: jnp.moveaxis(x, axis, 0), state)
/usr/local/lib/python3.10/dist-packages/jax/_src/numpy/lax_numpy.py:2522: in moveaxis
    return _moveaxis(arr, _ensure_index_tuple(source),
/usr/local/lib/python3.10/dist-packages/jax/_src/numpy/lax_numpy.py:2527: in _moveaxis
    source = tuple(_canonicalize_axis(i, np.ndim(a)) for i in source)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

.0 = <tuple_iterator object at 0x7f56542dda20>

>   source = tuple(_canonicalize_axis(i, np.ndim(a)) for i in source)
E   ValueError: axis 0 is out of bounds for array of dimension 0

/usr/local/lib/python3.10/dist-packages/jax/_src/numpy/lax_numpy.py:2527: ValueError
_______________________ TestScan.test_scan_with_sharding _______________________

self = <nnx.transforms_test.TestScan testMethod=test_scan_with_sharding>

    def test_scan_with_sharding(self):
      test = self
      state_axes = nnx.StateAxes({(nnx.Param, nnx.RngState): 0, ...: None})
      transform_metadata = {nnx.PARTITION_NAME: 'layers'}

      class MLP(nnx.Module):
        @nnx.split_rngs(splits=5)
        @nnx.vmap(
          in_axes=(state_axes, state_axes),
          transform_metadata=transform_metadata,
        )
        def __init__(self, rngs: nnx.Rngs):
          self.linear = nnx.Linear(
            3,
            3,
            kernel_init=nnx.with_metadata(
              nnx.initializers.lecun_normal(), sharding_names=('din', 'dout')
            ),
            bias_init=nnx.with_metadata(
              nnx.initializers.zeros_init(), sharding_names=('dout',)
            ),
            rngs=rngs,
          )

        @nnx.scan(
          in_axes=(state_axes, nnx.Carry), transform_metadata=transform_metadata
        )
        def __call__(self, x: jax.Array):
          x = self.linear(x)
          # test sharding layer axes is not present inside scan
          test.assertEqual(self.linear.kernel.shape, (3, 3))
          test.assertEqual(self.linear.kernel.sharding_names, ('din', 'dout'))
          test.assertEqual(self.linear.bias.shape, (3,))
          test.assertEqual(self.linear.bias.sharding_names, ('dout',))
          return x, None

      mesh = jax.make_mesh(((1, 1, 1)), ('layers', 'din', 'dout'))
      with set_mesh(mesh):
        m = MLP(rngs=nnx.Rngs(0))

      # test sharding layers axes is set
      self.assertEqual(m.linear.kernel.shape, (5, 3, 3))
>     self.assertEqual(m.linear.kernel.sharding_names, ('layers', 'din', 'dout'))
E     AssertionError: Tuples differ: ('din', 'dout') != ('layers', 'din', 'dout')
E
E     First differing element 0:
E     'din'
E     'layers'
E
E     Second tuple contains 1 additional elements.
E     First extra element 2:
E     'dout'
E
E     - ('din', 'dout')
E     + ('layers', 'din', 'dout')
E     ?  ++++++++++

tests/nnx/transforms_test.py:1735: AssertionError
____________________________ TestVmap.test_metadata ____________________________

self = <nnx.transforms_test.TestVmap testMethod=test_metadata>

    def test_metadata(self):
      @nnx.vmap(
        in_axes=(None,),
        out_axes=0,
        axis_size=5,
        transform_metadata={nnx.spmd.PARTITION_NAME: 'c'},
      )
      def create_block(rngs: nnx.Rngs):
        return nnx.Linear(
          16,
          32,
          rngs=rngs,
          kernel_init=nnx.with_partitioning(
            nnx.initializers.lecun_normal(), ('a', 'b')
          ),
        )


      mesh = jax.make_mesh(((1, 1, 1)), ('a', 'b', 'c'))
      with set_mesh(mesh):
        m = create_block(nnx.Rngs(0))
      self.assertEqual(m.kernel.value.shape, (5, 16, 32))
>     self.assertEqual(m.kernel.sharding_names, ('c', 'a', 'b'))

tests/nnx/transforms_test.py:2507:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = Param( # 2,560 (10.2 KB)
  value=Array([[[ 0.26754445, -0.24243177, -0.2011131 , ...,  0.11948797,
            0.45229......,  0.08493546,
           -0.0671915 , -0.21874464]]], dtype=float32),
  sharding="('c', 'a', 'b')",
  mesh='None'
)
name = 'sharding_names'

    def __getattr__(self, name: str) -> tp.Any:
      if name in object.__getattribute__(self, '_var_metadata'):
        return self._var_metadata[name]
>     return getattr(self.raw_value, name)
E     AttributeError: 'jaxlib._jax.ArrayImpl' object has no attribute 'sharding_names'

/usr/local/lib/python3.10/dist-packages/flax/nnx/variablelib.py:187: AttributeError
___________________________ TestVmap.test_replicate ____________________________

self = <nnx.transforms_test.TestVmap testMethod=test_replicate>

    def test_replicate(self):
      din = 3
      dout = 10

      class Block(nnx.Module):
        def __init__(self, rngs: nnx.Rngs):
          self.linear = nnx.Linear(din, dout, rngs=rngs)
          self.dropout = nnx.Dropout(0.5, deterministic=False, rngs=rngs)

        def __call__(self, x: jax.Array) -> jax.Array:
          return self.dropout(nnx.relu(self.linear(x)))

      def create_block(rngs: nnx.Rngs):
        return Block(rngs)

      state_axes = nnx.StateAxes({nnx.RngState: 0, ...: None})

      @nnx.split_rngs(splits=5)
      @partial(nnx.vmap, in_axes=(state_axes, 0), out_axes=0)
      def forward_block(module: Block, x):
        return module(x)

      rngs = nnx.Rngs(0)
      module = create_block(rngs)
>     initial_key = module.dropout.rngs.key.value
E     AttributeError: 'RngStream' object has no attribute 'value'

tests/nnx/transforms_test.py:2255: AttributeError
______________________ TestVmap.test_split_rngs_decorator ______________________

name = 'vmap', shape = (), axis = 0

    def _get_axis_size(name: str, shape: tuple[core.AxisSize, ...], axis: int
                       ) -> core.AxisSize:
      try:
>       return shape[axis]
E       IndexError: tuple index out of range

/usr/local/lib/python3.10/dist-packages/jax/_src/api.py:1175: IndexError

The above exception was the direct cause of the following exception:
Traceback (most recent call last):
  File "/usr/local/lib/python3.10/dist-packages/jax/_src/api.py", line 1175, in _get_axis_size
    return shape[axis]
IndexError: tuple index out of range

The above exception was the direct cause of the following exception:

jax.errors.SimplifiedTraceback: For simplicity, JAX has removed its internal frames from the traceback of the following exception. Set JAX_TRACEBACK_FILTERING=off to include these.

The above exception was the direct cause of the following exception:

self = <nnx.transforms_test.TestVmap testMethod=test_split_rngs_decorator>

    def test_split_rngs_decorator(self):
      class Block(nnx.Module):
        def __init__(self, rngs: nnx.Rngs):
          self.linear = nnx.Linear(3, 3, rngs=rngs)
          self.dropout = nnx.Dropout(0.5, deterministic=False, rngs=rngs)

        def __call__(self, x: jax.Array) -> jax.Array:
          x = self.linear(x)
          x = nnx.relu(x)
          x = self.dropout(x)
          return x

      state_axes = nnx.StateAxes({(nnx.Param, nnx.RngState): 0, ...: None})

      @nnx.split_rngs(splits=5)
      @nnx.vmap(in_axes=(state_axes,), out_axes=state_axes)
      def create_block(rngs: nnx.Rngs):
        return Block(rngs)

      rngs = nnx.Rngs(0)
      initial_key = rngs.default.key.value

      module = create_block(rngs)

      assert rngs.default.count.value == 1
      assert rngs.default.key.value == initial_key
      assert not jnp.allclose(
        module.linear.kernel.value[0],
        module.linear.kernel.value[1],
      )
      assert module.linear.kernel.value.shape == (5, 3, 3)
      assert module.linear.bias.value.shape == (5, 3)

      x = jnp.ones((5, 1, 3))

      @nnx.vmap(in_axes=(state_axes, 0))
      def forward_block(module, x):
        self.assertEqual(x.shape, (1, 3))
        return module(x)

>     y = forward_block(module, x)

tests/nnx/transforms_test.py:2116:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/graph.py:2051: in update_context_manager_wrapper
    return f(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

args = (Block( # RngState: 2 (12 B), Param: 60 (240 B), Total: 62 (252 B)
  dropout=Dropout( # RngState: 2 (12 B)
    broadca... 1.]],

       [[1., 1., 1.]],

       [[1., 1., 1.]],

       [[1., 1., 1.]],

       [[1., 1., 1.]]], dtype=float32))
kwargs = {}
pure_args = (NodeStates(_graphdef=GraphDef(nodes=[NodeDef(
  type='Block',
  index=0,
  outer_index=None,
  num_attributes=3,
  me... 1.]],

       [[1., 1., 1.]],

       [[1., 1., 1.]],

       [[1., 1., 1.]],

       [[1., 1., 1.]]], dtype=float32))

    @functools.wraps(f)
    @graph.update_context('vmap')
    def vmap_wrapper(*args, **kwargs):
      args = resolve_kwargs(f, args, kwargs)
      pure_args = extract.to_tree(
          args, prefix=in_axes, split_fn=_vmap_split_fn, ctxtag='vmap'
      )
>     pure_args_out, pure_out = vmapped_fn(*pure_args)
E     ValueError: vmap was requested to map its argument along axis 0, which implies that its rank should be at least 1, but is only 0 (its shape is ())

/usr/local/lib/python3.10/dist-packages/flax/nnx/transforms/iteration.py:348: ValueError
__________________ TestVmap.test_split_rngs_decorator_simple ___________________

self = <nnx.transforms_test.TestVmap testMethod=test_split_rngs_decorator_simple>

    def test_split_rngs_decorator_simple(self):
      class Block(nnx.Module):
        def __init__(self, rngs: nnx.Rngs):
          self.linear = nnx.Linear(2, 3, rngs=rngs)
          self.bn = nnx.BatchNorm(3, rngs=rngs)
          self.dropout = nnx.Dropout(0.1, deterministic=False, rngs=rngs)

        def __call__(self, x: jax.Array) -> jax.Array:
          return nnx.relu(self.dropout(self.bn(self.linear(x))))

      state_axes = nnx.StateAxes({(nnx.BatchStat, 'dropout'): 0, ...: None})

      @nnx.split_rngs(splits=5, only='dropout')
      @nnx.vmap(in_axes=(state_axes,), out_axes=state_axes)
      def create_block(rngs: nnx.Rngs):
        return Block(rngs)

      rngs = nnx.Rngs(params=0, dropout=1)

      module = create_block(rngs)

      assert module.linear.kernel.value.shape == (2, 3)
      assert module.bn.scale.value.shape == (3,)
      assert module.bn.mean.value.shape == (5, 3)
      assert module.dropout.rngs is not None
>     self.assertEqual(module.dropout.rngs.key.shape, (5,))

tests/nnx/transforms_test.py:2184:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
/usr/local/lib/python3.10/dist-packages/flax/nnx/rnglib.py:227: in __getattr__
    return self._get_stream(name, AttributeError)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = Rngs( # RngState: 4 (24 B)
  dropout=RngStream( # RngState: 2 (12 B)
    count=RngCount( # 1 (4 B)
      value=Array(1...(8 B)
      value=Array((), dtype=key<fry>) overlaying:
      [0 0],
      tag="'params'"
    ),
    tag='params'
  )
)
name = 'key', error_type = <class 'AttributeError'>

    def _get_stream(self, name: str, error_type: type[Exception]) -> RngStream:
      rngs_vars = vars(self)
      if name not in rngs_vars:
        if 'default' not in rngs_vars:
>         raise error_type(f"No RNG named {name!r} or 'default' found in Rngs.")
E         AttributeError: No RNG named 'key' or 'default' found in Rngs.

/usr/local/lib/python3.10/dist-packages/flax/nnx/rnglib.py:216: AttributeError
_______________________ TestPmap.test_basic_demo_single ________________________

self = <nnx.transforms_test.TestPmap testMethod=test_basic_demo_single>

    def test_basic_demo_single(self):
      class Block(nnx.Module):
        def __init__(self, rngs: nnx.Rngs):
          self.linear = nnx.Linear(20, 20, rngs=rngs)
          self.dropout = nnx.Dropout(0.2, deterministic=False, rngs=rngs)

        def __call__(self, x: jax.Array) -> jax.Array:
          return self.dropout(nnx.relu(self.linear(x)))

      @nnx.split_rngs(splits=1)
      @nnx.pmap(axis_size=1)
      def create_block(rngs: nnx.Rngs):
        return Block(rngs)

      @nnx.pmap(axis_size=1)
      def forward_block(module: Block, x):
        return module(x)

      rngs = nnx.Rngs(0)
      module = create_block(rngs)

>     assert module.dropout.rngs.count.value == 0
E     AttributeError: 'RngStream' object has no attribute 'value'

tests/nnx/transforms_test.py:2613: AttributeError
__________________________ TestPmap.test_basic_single __________________________

self = <nnx.transforms_test.TestPmap testMethod=test_basic_single>

    def test_basic_single(self):
      class Block(nnx.Module):
        def __init__(self, rngs: nnx.Rngs):
          self.linear = nnx.Linear(3, 10, rngs=rngs)
          self.dropout = nnx.Dropout(0.5, deterministic=False, rngs=rngs)

        def __call__(self, x: jax.Array) -> jax.Array:
          x = self.linear(x)
          x = nnx.elu(x)
          x = self.dropout(x)
          return x

      state_axes = nnx.StateAxes({(nnx.Param, nnx.RngState): 0, ...: None})

      @nnx.split_rngs(splits=1)
      @nnx.pmap(in_axes=(state_axes,), out_axes=state_axes, axis_size=1)
      def create_block(rngs: nnx.Rngs):
        return Block(rngs)

      rngs = nnx.Rngs(0)
      module = create_block(rngs)
>     initial_key = module.dropout.rngs.key.value
E     AttributeError: 'RngStream' object has no attribute 'value'

tests/nnx/transforms_test.py:2570: AttributeError
________________________ TestPmap.test_replicate_single ________________________

self = <nnx.transforms_test.TestPmap testMethod=test_replicate_single>

    def test_replicate_single(self):
      din = 3
      dout = 10

      class Block(nnx.Module):
        def __init__(self, rngs: nnx.Rngs):
          self.linear = nnx.Linear(din, dout, rngs=rngs)
          self.dropout = nnx.Dropout(0.5, deterministic=False, rngs=rngs)

        def __call__(self, x: jax.Array) -> jax.Array:
          return self.dropout(nnx.relu(self.linear(x)))

      def create_block(rngs: nnx.Rngs):
        return Block(rngs)

      state_axes = nnx.StateAxes({nnx.RngState: 0, ...: None})

      @nnx.split_rngs(splits=1)
      @partial(nnx.pmap, in_axes=(state_axes, 0), out_axes=0, axis_size=1)
      def forward_block(module: Block, x):
        return module(x)

      rngs = nnx.Rngs(0)
      module = create_block(rngs)
>     initial_key = module.dropout.rngs.key.value
E     AttributeError: 'RngStream' object has no attribute 'value'

tests/nnx/transforms_test.py:2653: AttributeError
_____________________________ TestCond.test_basic ______________________________

self = <nnx.transforms_test.TestCond testMethod=test_basic>

    def test_basic(self):
      class TimeStep(tp.NamedTuple):
        step: nnx.Variable[jax.Array]
        reward: nnx.Variable[jax.Array]

        @staticmethod
        def zero():
          return TimeStep(
              step=nnx.Variable(jnp.array(0)), reward=nnx.Variable(jnp.array(0.0))
          )

      @dataclasses.dataclass
>     class Foo(nnx.Pytree):
E     AttributeError: module 'flax.nnx' has no attribute 'Pytree'

tests/nnx/transforms_test.py:2687: AttributeError
_________________________ TestCond.test_cond_and_vmap __________________________

self = <nnx.transforms_test.TestCond testMethod=test_cond_and_vmap>

    def test_cond_and_vmap(self):
>     class Env(nnx.Pytree):
E     AttributeError: module 'flax.nnx' has no attribute 'Pytree'

tests/nnx/transforms_test.py:2740: AttributeError
__________________ TestWhileLoop.test_fori_loop_with_sharing ___________________

self = <nnx.transforms_test.TestWhileLoop testMethod=test_fori_loop_with_sharing>

    def test_fori_loop_with_sharing(self):
>     class A(nnx.Pytree):
E     AttributeError: module 'flax.nnx' has no attribute 'Pytree'

tests/nnx/transforms_test.py:2944: AttributeError
_________________ TestSplitMergeInputs.test_split_inputs_vmap __________________

self = <nnx.transforms_test.TestSplitMergeInputs testMethod=test_split_inputs_vmap>

    def test_split_inputs_vmap(self):
      class EnvState(nnx.Variable[nnx.A]):
        pass

>     class Env(nnx.Pytree):
E     AttributeError: module 'flax.nnx' has no attribute 'Pytree'

tests/nnx/transforms_test.py:3048: AttributeError
___________________ TestVariable.test_mutable_array_context ____________________

self = <nnx.variable_test.TestVariable testMethod=test_mutable_array_context>

    def test_mutable_array_context(self):
>     with nnx.use_refs(False):
E     AttributeError: module 'flax.nnx' has no attribute 'use_refs'

tests/nnx/variable_test.py:97: AttributeError
=========================== short test summary info ============================
FAILED tests/core/core_scope_test.py::ScopeTest::test_rng_check_w_lazy_rng - ...
FAILED tests/linen/linen_module_test.py::ModuleTest::test_cloudpickle_class
FAILED tests/linen/linen_module_test.py::ModuleTest::test_cloudpickle_module
FAILED tests/linen/partitioning_test.py::PartitioningTest::test_logical_to_mesh_axes
FAILED tests/nnx/bridge/module_test.py::TestBridgeModule::test_metadata - Att...
FAILED tests/nnx/bridge/wrappers_test.py::TestCompatibility::test_linen_to_nnx_metadata
FAILED tests/nnx/bridge/wrappers_test.py::TestCompatibility::test_nnx_linen_nnx
FAILED tests/nnx/bridge/wrappers_test.py::TestCompatibility::test_nnx_to_linen_metadata
FAILED tests/nnx/bridge/wrappers_test.py::TestCompatibility::test_to_linen_abtract_init
FAILED tests/nnx/bridge/wrappers_test.py::TestCompatibility::test_to_linen_method_call
FAILED tests/nnx/bridge/wrappers_test.py::TestCompatibility::test_to_linen_nnx_method_arg
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_data_after_init - ...
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_find_duplicates - ...
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_flatten_unflatten_unkown_leaves
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_object_state_propagation
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_pop_dict - ValueEr...
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_pytree_node - Attr...
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_shared_state_variables_shared_with_graph
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_split_filter_variable
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_split_merge_context_example
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_split_merge_unkown_leaves
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_split_merge_unkown_leaves_with_filters
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_split_merge_update_context
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_split_update_filter_variable
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_split_update_variable
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_split_variable - A...
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_state_variables_shared_with_graph
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_to_tree_update_context
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_unflatten - Attrib...
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_unflatten_empty - ...
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_unflatten_pure_dict
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_unflatten_return_variables
FAILED tests/nnx/graph_utils_test.py::TestGraphUtils::test_update_dict - Valu...
FAILED tests/nnx/integration_test.py::TestIntegration::test_example_mutable_arrays
FAILED tests/nnx/mutable_array_test.py::TestOptimizer::test_optimize_arrays
FAILED tests/nnx/mutable_array_test.py::TestOptimizer::test_optimize_mutable_arrays
FAILED tests/nnx/nn/attention_test.py::TestMultiHeadAttention::test_keep_rngs0
FAILED tests/nnx/nn/recurrent_test.py::TestRNN::test_recurrent_dropout - Type...
FAILED tests/nnx/nn/stochastic_test.py::TestStochastic::test_dropout_internal_rngs
FAILED tests/nnx/nn/stochastic_test.py::TestStochastic::test_dropout_rng_override
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_jit0 - AttributeError...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_jit1 - AttributeError...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_jit10 - AttributeErro...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_jit11 - AttributeErro...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_jit2 - AttributeError...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_jit3 - AttributeError...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_jit4 - AttributeError...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_jit5 - AttributeError...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_jit6 - AttributeError...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_jit7 - AttributeError...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_jit8 - AttributeError...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_jit9 - AttributeError...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_jit_linesearch0 - Att...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_jit_linesearch1 - Att...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_jit_linesearch2 - Att...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_jit_linesearch3 - Att...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_jit_linesearch4 - Att...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_jit_linesearch5 - Att...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_metrics0 - AttributeE...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_metrics1 - AttributeE...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_metrics2 - AttributeE...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_metrics3 - AttributeE...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_sharding_propagation
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_update - TypeError: O...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_wrt_update0 - TypeErr...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_wrt_update1 - TypeErr...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_wrt_update2 - TypeErr...
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_wrt_update_linesearch0
FAILED tests/nnx/optimizer_test.py::TestOptimizer::test_wrt_update_linesearch1
FAILED tests/nnx/rngs_test.py::TestRngs::test_fallback_error_no_default - Ass...
FAILED tests/nnx/rngs_test.py::TestRngs::test_random_helpers - TypeError: Rng...
FAILED tests/nnx/spmd_test.py::TestSPMD::test_add_remove_axis_in_transform - ...
FAILED tests/nnx/spmd_test.py::TestSPMD::test_init - AttributeError: 'tuple' ...
FAILED tests/nnx/state_test.py::StateTest::test_pure_dict - AssertionError: a...
FAILED tests/nnx/summary_test.py::SummaryTest::test_tabulate - AssertionError...
FAILED tests/nnx/transforms_test.py::TestJIT::test_cached_unflatten_add_self_reference
FAILED tests/nnx/transforms_test.py::TestJIT::test_cached_unflatten_ref_in_output
FAILED tests/nnx/transforms_test.py::TestJIT::test_mutable_array_input_output
FAILED tests/nnx/transforms_test.py::TestEvalShape::test_eval_shape_mutable_array
FAILED tests/nnx/transforms_test.py::TestGrad::test_grad - AssertionError: as...
FAILED tests/nnx/transforms_test.py::TestGrad::test_grad_with_multiple_ref_types
FAILED tests/nnx/transforms_test.py::TestGrad::test_grad_with_type_predicate
FAILED tests/nnx/transforms_test.py::TestGrad::test_value_and_grad_with_aux
FAILED tests/nnx/transforms_test.py::TestGrad::test_variables_in_grad - Asser...
FAILED tests/nnx/transforms_test.py::TestScan::test_cache_tracing_object - At...
FAILED tests/nnx/transforms_test.py::TestScan::test_complex - ValueError: axi...
FAILED tests/nnx/transforms_test.py::TestScan::test_complex_decorator - Value...
FAILED tests/nnx/transforms_test.py::TestScan::test_scan_with_sharding - Asse...
FAILED tests/nnx/transforms_test.py::TestVmap::test_metadata - AttributeError...
FAILED tests/nnx/transforms_test.py::TestVmap::test_replicate - AttributeErro...
FAILED tests/nnx/transforms_test.py::TestVmap::test_split_rngs_decorator - Va...
FAILED tests/nnx/transforms_test.py::TestVmap::test_split_rngs_decorator_simple
FAILED tests/nnx/transforms_test.py::TestPmap::test_basic_demo_single - Attri...
FAILED tests/nnx/transforms_test.py::TestPmap::test_basic_single - AttributeE...
FAILED tests/nnx/transforms_test.py::TestPmap::test_replicate_single - Attrib...
FAILED tests/nnx/transforms_test.py::TestCond::test_basic - AttributeError: m...
FAILED tests/nnx/transforms_test.py::TestCond::test_cond_and_vmap - Attribute...
FAILED tests/nnx/transforms_test.py::TestWhileLoop::test_fori_loop_with_sharing
FAILED tests/nnx/transforms_test.py::TestSplitMergeInputs::test_split_inputs_vmap
FAILED tests/nnx/variable_test.py::TestVariable::test_mutable_array_context
ERROR docs/_ext/codediff_test.py
ERROR docs_nnx/_ext/codediff_test.py
ERROR examples/gemma/input_pipeline_test.py
ERROR examples/gemma/layers_test.py
ERROR examples/gemma/modules_test.py
ERROR examples/gemma/sampler_test.py
ERROR examples/gemma/transformer_test.py
ERROR examples/imagenet/train_test.py
ERROR examples/lm1b/input_pipeline_test.py
ERROR examples/lm1b/train_test.py
ERROR examples/lm1b_nnx/input_pipeline_test.py
ERROR examples/lm1b_nnx/models_test.py
ERROR examples/lm1b_nnx/temperature_sampler_test.py
ERROR examples/lm1b_nnx/train_test.py
ERROR examples/mnist/train_test.py
ERROR examples/nlp_seq/input_pipeline_test.py
ERROR examples/ogbg_molpcba/input_pipeline_test.py
ERROR examples/ogbg_molpcba/models_test.py
ERROR examples/ogbg_molpcba/train_test.py
ERROR examples/ppo/ppo_lib_test.py
ERROR examples/ppo/test_episodes.py
ERROR examples/seq2seq/train_test.py
ERROR examples/sst2/input_pipeline_test.py
ERROR examples/sst2/models_test.py
ERROR examples/sst2/train_test.py
ERROR examples/wmt/input_pipeline_test.py
ERROR examples/wmt/train_test.py
ERROR tests/io_test.py
ERROR tests/nnx/helpers_test.py - AttributeError: module 'flax.nnx' has no at...
ERROR tests/nnx/module_test.py
ERROR tests/tensorboard_test.py
ERROR tests/nnx/mutable_array_test.py::TestObject::test_data_example - Attrib...
ERROR tests/nnx/mutable_array_test.py::TestObject::test_pytree - AttributeErr...
ERROR tests/nnx/mutable_array_test.py::TestObject::test_pytree_data_instance
ERROR tests/nnx/mutable_array_test.py::TestObject::test_pytree_data_typehint
ERROR tests/nnx/mutable_array_test.py::TestObject::test_pytree_dataclass - At...
ERROR tests/nnx/mutable_array_test.py::TestObject::test_register_data_type - ...
ERROR tests/nnx/mutable_array_test.py::TestMutableArrayGraph::test_freeze_and_mutable
ERROR tests/nnx/mutable_array_test.py::TestMutableArrayGraph::test_freeze_and_mutable_with_filter
ERROR tests/nnx/mutable_array_test.py::TestMutableArrayGraph::test_freeze_duplicate_error
ERROR tests/nnx/mutable_array_test.py::TestMutableArrayGraph::test_mutable_array_split
ERROR tests/nnx/mutable_array_test.py::TestMutableArrayGraph::test_mutable_array_split_freeze
ERROR tests/nnx/mutable_array_test.py::TestMutableArrayGraph::test_mutable_array_split_merge_in_variable
ERROR tests/nnx/mutable_array_test.py::TestMutableArrayGraph::test_mutable_array_split_merge_in_variable_shared_array
ERROR tests/nnx/mutable_array_test.py::TestMutableArrayGraph::test_mutable_example
ERROR tests/nnx/mutable_array_test.py::TestMutableArrayGraph::test_split_mutable_array
ERROR tests/nnx/mutable_array_test.py::TestMutableArrayGraph::test_to_arrays_example
ERROR tests/nnx/mutable_array_test.py::TestMutableArrayGraph::test_update_context
ERROR tests/nnx/mutable_array_test.py::TestMutableArrayGraph::test_update_context_flatten
ERROR tests/nnx/mutable_array_test.py::TestMutableArrayGraph::test_update_context_to_tree1
ERROR tests/nnx/mutable_array_test.py::TestMutableArrayGraph::test_update_context_to_tree2
ERROR tests/nnx/mutable_array_test.py::TestMutableArrayGraph::test_update_context_to_tree_trivial_prefix
ERROR tests/nnx/mutable_array_test.py::TestMutableArrayNNXTransforms::test_jit_mutable
ERROR tests/nnx/mutable_array_test.py::TestMutableArrayNNXTransforms::test_simple_jit
ERROR tests/nnx/mutable_array_test.py::TestMutableArray::test_object - Attrib...
ERROR tests/nnx/mutable_array_test.py::TestMutableArray::test_object_state - ...
ERROR tests/nnx/mutable_array_test.py::TestMutableArray::test_rngs_call - Att...
ERROR tests/nnx/mutable_array_test.py::TestMutableArray::test_rngs_create - A...
ERROR tests/nnx/mutable_array_test.py::TestMutableArray::test_static - Attrib...
ERROR tests/nnx/mutable_array_test.py::TestMutableArray::test_variable_creation
ERROR tests/nnx/mutable_array_test.py::TestMutableArray::test_variable_metadata
====== 100 failed, 1995 passed, 1 skipped, 61 errors in 329.93s (0:05:29) ======
